<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lopix.app</title>

    <!-- === DEPENDÊNCIAS === -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MediaPipe Face Mesh -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- === FIREBASE SDK === -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCgUsCL6aE8q6AzjLFkOEiucIXSuG4N0Bo",
            authDomain: "provadorvirtuais.firebaseapp.com",
            projectId: "provadorvirtuais",
            storageBucket: "provadorvirtuais.firebasestorage.app",
            messagingSenderId: "737418982726",
            appId: "1:737418982726:web:7b6c30198517dd8ba72147"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        console.log("Firebase e Firestore inicializados com sucesso!");
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- ESTILOS DINÂMICOS DA LOJA -->
    <style id="store-custom-styles">
        /* Será preenchido via JS com a cor da loja */
    </style>

    <style>
        /* --- ESTILOS GERAIS --- */
        body {
            background-color: #f8fafc;
            color: #1e293b;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            overflow-x: hidden;
        }

        /* --- AR CANVAS --- */
        #canvas-wrapper {
            position: relative;
            width: 100%;
            max-width: 720px;
            margin: 0 auto;
            border-radius: 1.5rem;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(37, 99, 235, 0.15);
            aspect-ratio: 4/3;
            background: #e2e8f0;
            cursor: default;
            touch-action: none;
            border: 4px solid #ffffff;
            transition: all 0.3s ease;
        }

        #canvas-wrapper.grabbing {
            cursor: grabbing;
        }

        #canvas-wrapper.pointer {
            cursor: pointer;
        }

        /* Estilo específico quando o canvas está no modo Provador Fullscreen */
        #canvas-wrapper.tryon-mode {
            max-width: 100%;
            width: 100%;
            height: 100%;
            border-radius: 0;
            border: none;
            margin: 0;
            aspect-ratio: auto;
            /* Remove proporção fixa para preencher */
            background: #000;
        }

        video,
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.1s ease-out;
            transform-origin: center center;
        }

        video {
            transform: scaleX(-1);
            opacity: 0;
        }

        .loader {
            border: 4px solid #cbd5e1;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* --- UI ADMIN & MASTER --- */
        .part-card {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e2e8f0;
            background-color: #ffffff;
        }

        .part-card:hover {
            border-color: #93c5fd;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .part-card.active {
            border-color: #2563eb;
            background-color: #eff6ff;
            box-shadow: 0 0 0 1px #2563eb;
        }

        .custom-checkbox {
            appearance: none;
            width: 22px;
            height: 22px;
            border: 2px solid #94a3b8;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            background-color: white;
        }

        .custom-checkbox:checked {
            background-color: #2563eb;
            border-color: #2563eb;
        }

        .custom-checkbox:checked::after {
            content: '✔';
            position: absolute;
            color: white;
            font-size: 14px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .btn-upload-large {
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f1f5f9;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #cbd5e1;
            color: #64748b;
        }

        .btn-upload-large:hover {
            background-color: #2563eb;
            border-color: #2563eb;
            color: white;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            margin-top: -7px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 2px solid white;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #cbd5e1;
            border-radius: 2px;
        }

        .disabled-control {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(1);
        }

        /* --- TOASTS --- */
        #toast-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: #ffffff;
            border-left: 4px solid;
            color: #1e293b;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
            max-width: 320px;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-error {
            border-color: #ef4444;
            color: #7f1d1d;
        }

        .toast-success {
            border-color: #22c55e;
            color: #14532d;
        }

        .toast-info {
            border-color: #3b82f6;
            color: #1e3a8a;
        }

        /* --- VITRINE & UTILITÁRIOS --- */
        .glass-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }

        .glass-card:active {
            transform: scale(0.98);
        }

        .hidden-view {
            display: none !important;
        }

        /* --- MODALS (Login & Confirm) --- */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        /* FULLSCREEN OVERLAY FOR ADMIN/MASTER */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #f8fafc;
            z-index: 999;
            overflow-y: auto;
        }

        /* --- TELA BLOQUEIO (Inadimplência) --- */
        #blocked-screen {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: #0f172a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 2rem;
        }

        #blocked-screen.hidden {
            display: none !important;
        }

        /* --- PROVADOR FULLSCREEN (ESTILO INSTAGRAM/SNAPCHAT) --- */
        #tryon-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: #000;
            /* Flex removido para usar posicionamento absoluto para overlay real */
        }

        #tryon-video-container {
            position: absolute;
            inset: 0;
            /* Ocupa toda a tela */
            width: 100%;
            height: 100%;
            z-index: 0;
            /* Fica no fundo */
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        /* NEW FOOTER BUTTON CONTAINER (Replaces Gallery) */
        #tryon-footer {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            /* Allows click-through outside button */
            width: 100%;
            /* Garante centralização */
        }

        /* CLEAN BLUE BUTTON STYLE */
        .btn-try-other {
            pointer-events: auto;
            background-color: #2563eb;
            /* Tailwind Blue 600 */
            color: white;
            font-weight: 600;
            padding: 12px 32px;
            border-radius: 9999px;
            box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            cursor: pointer;
        }

        .btn-try-other:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(37, 99, 235, 0.6);
            background-color: #1d4ed8;
        }

        .btn-try-other:active {
            transform: scale(0.95);
        }

        /* --- MODELOS DIGITAIS (AI) --- */
        #view-digital-models {
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            font-family: 'Outfit', sans-serif;
        }

        .ai-glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .ai-step {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }

        .ai-step.active {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        .ai-input-base {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s;
        }

        .ai-input-base:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        .ai-btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .ai-btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 15px 25px -5px rgba(37, 99, 235, 0.5);
            filter: brightness(1.1);
        }

        .ai-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .ai-drop-zone {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            transition: all 0.2s;
        }

        .ai-drop-zone:hover,
        .ai-drop-zone.dragover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
    </style>
</head>

<body class="flex flex-col min-h-screen">

    <!-- ================================================================= -->
    <!-- TELA DE BLOQUEIO (Oculta por padrão) -->
    <!-- ================================================================= -->
    <div id="blocked-screen" class="hidden">
        <div class="bg-red-500/10 p-6 rounded-full mb-6 animate-pulse">
            <i class="fa-solid fa-ban text-6xl text-red-500"></i>
        </div>
        <h1 class="text-3xl font-bold mb-4">Acesso Temporariamente Suspenso</h1>
        <p class="text-slate-400 text-lg max-w-md">
            Provador virtual fora do ar por falta de pagamento.
        </p>
        <p class="text-sm text-slate-600 mt-8">Entre em contato com o suporte para regularização.</p>
    </div>

    <!-- ================================================================= -->
    <!-- VIEW 1: VITRINE (Padrão: Visível) -->
    <!-- ================================================================= -->
    <div id="view-vitrine" class="w-full h-full bg-gray-50 text-slate-800 antialiased">
        <!-- CABEÇALHO VITRINE -->
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center h-16"> <!-- Altura Fixa -->
                <!-- LOGO COM DETECTOR DE CLIQUES -->
                <div class="flex items-center gap-2 cursor-pointer select-none h-full" onclick="handleLogoClick()"
                    oncontextmenu="handleLogoRightClick(event)" title="Lopix App" id="store-logo-container">
                    <!-- Conteúdo padrão (será substituído se houver logo customizada) -->
                    <div class="flex items-center gap-2" id="default-logo-content">
                        <i class="fa-solid fa-glasses text-2xl text-black"></i>
                        <h1 class="text-xl font-bold tracking-tight">LOPIX<span class="font-light">APP</span></h1>
                    </div>
                    <!-- Imagem customizada (inicialmente oculta) -->
                    <img id="custom-logo-img" class="h-10 w-auto object-contain hidden" alt="Logo da Loja">
                </div>
                <div class="text-xs text-gray-400 font-medium" id="store-label">Vitrine Oficial</div>
            </div>
        </header>

        <!-- Banner -->
        <div class="w-full relative">
            <img id="store-banner" src="https://i.ibb.co/m1J8Gdx/01.jpg" alt="Coleção Nova"
                class="w-full h-auto block max-h-[400px] object-cover">
        </div>

        <!-- Botão Visagismo Digital (Visível apenas se habilitado no Master Panel) -->
        <div class="container mx-auto px-4 pt-4 hidden" id="vitrine-visagismo-container">
            <button onclick="openVisagismoFromVitrine()"
                class="w-full md:w-auto bg-white border border-gray-200 text-gray-900 hover:border-black hover:text-black hover:bg-gray-50 transition-all duration-300 px-6 py-3.5 rounded-xl font-bold shadow-sm hover:shadow-md flex items-center justify-center gap-2 group">
                <i data-lucide="scan-face" class="w-5 h-5 text-gray-500 group-hover:text-black transition-colors"></i>
                <span>Visagismo Digital</span>
            </button>
        </div>

        <!-- ÁREA PRINCIPAL -->
        <main class="container mx-auto px-4 py-8 pb-24">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-gray-800 border-l-4 border-black pl-3" id="store-collection-title">
                    Coleção de Óculos</h3>
            </div>

            <!-- NOVO: Filtros de Categoria (Visual Clean) -->
            <div class="flex flex-wrap gap-2 mb-8 overflow-x-auto pb-2 scrollbar-hide" id="vitrine-category-filters">
                <!-- Injetado via JS -->
            </div>

            <!-- Grid de Produtos -->
            <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- JS Injeta Produtos Aqui -->
            </div>
        </main>

        <!-- WHATSAPP FIXO -->
        <div class="fixed bottom-6 left-0 right-0 px-4 z-50 flex justify-center pointer-events-none">
            <a href="https://api.whatsapp.com/send/?phone=5511999999999&text=Olá!%20Vim%20pelo%20site." target="_blank"
                id="whatsapp-btn"
                class="pointer-events-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg flex items-center gap-2 w-auto max-w-full justify-center transform transition hover:-translate-y-1 whitespace-nowrap text-sm md:text-base cursor-pointer no-underline btn-store-primary">
                Fale Conosco
            </a>
        </div>
    </div>

    <!-- ================================================================= -->
    <!-- VIEW 2: PAINEL ADMINISTRATIVO (Lojas) -->
    <!-- ================================================================= -->
    <div id="view-admin" class="fullscreen-overlay hidden-view flex flex-col">
        <!-- Header Admin -->
        <header class="w-full bg-white border-b border-slate-200 sticky top-0 z-20 shadow-sm">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2.5 rounded-xl shadow-lg shadow-blue-200">
                        <i data-lucide="glasses" class="text-white w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-800 tracking-tight">Lopix <span
                                class="text-blue-600">Admin</span></h1>
                        <p class="text-xs text-slate-500 font-medium tracking-wide" id="admin-subtitle">Painel de
                            Criação</p>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <button onclick="logoutAdmin()" class="text-sm font-semibold text-red-500 hover:text-red-700">
                        Sair (Voltar ao Site)
                    </button>
                    <div class="flex bg-slate-100 rounded-xl p-1.5 border border-slate-200">
                        <!-- Botões de Navegação Atualizados com Lógica de Visibilidade -->
                        <button onclick="switchMode('editor')" id="btn-editor"
                            class="flex items-center gap-2 px-5 py-2 text-sm font-semibold rounded-lg text-slate-500 hover:text-slate-700 transition-all border border-transparent">
                            <i data-lucide="edit-3" class="w-4 h-4"></i> Editor
                        </button>
                        <button onclick="switchMode('list')" id="btn-preview"
                            class="flex items-center gap-2 px-5 py-2 text-sm font-semibold rounded-lg text-slate-500 hover:text-slate-700 transition-all border border-transparent">
                            <i data-lucide="layout-grid" class="w-4 h-4"></i> Painel (Óculos)
                        </button>
                        <button onclick="switchMode('config')" id="btn-config"
                            class="flex items-center gap-2 px-5 py-2 text-sm font-semibold rounded-lg text-slate-500 hover:text-slate-700 transition-all border border-transparent">
                            <i data-lucide="settings" class="w-4 h-4"></i> Configuração
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- FIXED: Alterado justify-center para justify-start para garantir rolagem correta e não cortar o topo -->
        <main class="flex-1 w-full max-w-[1400px] mx-auto p-6 lg:p-10 flex flex-col gap-12 items-start justify-start">

            <!-- EDITOR VIEW CONTAINER (Agrupado para toggle) -->
            <div id="admin-editor-view" class="w-full flex flex-col lg:flex-row gap-12 items-start justify-center">
                <!-- ESQUERDA: CÂMERA (AR Engine) - Importante: ID Adicionado ao container pai -->
                <div id="admin-ar-container" class="w-full lg:flex-[1.5] flex flex-col items-center gap-6 relative">
                    <div id="canvas-wrapper" class="relative group w-full">
                        <div id="loading-overlay"
                            class="absolute inset-0 flex flex-col items-center justify-center bg-slate-50 z-30">
                            <div class="loader mb-6"></div>
                            <p class="text-base font-semibold text-slate-600 animate-pulse">Inicializando MediaPipe...
                            </p>
                        </div>

                        <video id="video" playsinline autoplay muted></video>
                        <canvas id="output-canvas"></canvas>

                        <!-- UI Sobreposta (Editor) -->
                        <div id="editor-ui"
                            class="absolute inset-0 z-20 flex flex-col justify-between p-6 pointer-events-none hidden">
                            <div class="flex justify-between items-start">
                                <!-- Rastreamento Ativo Removed -->
                                <div class="hidden" id="edit-indicator">
                                    <span class="text-[10px] text-blue-100 uppercase tracking-wider block mb-0.5">Modo
                                        Edição</span>
                                    <span class="text-sm font-bold text-white flex items-center gap-2"
                                        id="editing-label">
                                        <i data-lucide="mouse-pointer-2" class="w-4 h-4"></i> Selecione
                                    </span>
                                </div>
                            </div>

                            <!-- Dica de Arrastar -->
                            <div class="flex justify-center pb-4 transition-opacity duration-300" id="drag-hint">
                                <div class="bg-black/20 backdrop-blur-sm px-4 py-2 rounded-full border border-white/10 text-center shadow-sm flex gap-2 text-xs font-medium text-white/90 pointer-events-auto"
                                    id="hint-content">
                                    <!-- Dynamic Content -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex items-center gap-2 text-slate-500 bg-white px-4 py-2 rounded-full border border-slate-200 shadow-sm text-sm">
                        <i data-lucide="mouse" class="w-4 h-4 text-blue-500"></i>
                        <span>Use o <b>scroll</b> para zoom • <b>Botão direito</b> para ajustar altura das hastes</span>
                    </div>
                </div>

                <!-- DIREITA: PAINEL DE CONTROLES -->
                <div id="editor-panel" class="w-full lg:w-96 flex flex-col gap-6 animate-fade-in lg:sticky lg:top-28">

                    <!-- Seleção de Peças -->
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <div class="flex items-center justify-between mb-5">
                            <h2 class="text-base font-bold text-slate-800 flex items-center gap-2">
                                <i data-lucide="layers" class="w-5 h-5 text-blue-600"></i> Componentes
                            </h2>
                            <div class="flex gap-2">
                                <button onclick="saveCurrentAsDefault()"
                                    class="text-xs font-medium text-blue-500 hover:text-blue-600 hover:bg-blue-50 px-2 py-1 rounded transition-colors border border-transparent hover:border-blue-100"
                                    title="Salvar ajustes atuais como padrão para novos uploads">
                                    Salvar Padrão
                                </button>
                                <button onclick="clearStorage()"
                                    class="text-xs font-medium text-red-500 hover:text-red-600 hover:bg-red-50 px-2 py-1 rounded transition-colors">
                                    Limpar Tudo
                                </button>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <!-- Frente -->
                            <div class="part-card p-3 rounded-xl cursor-pointer flex items-center gap-4 group"
                                id="card-front" onclick="selectPart('front')">
                                <div class="flex items-center justify-center" onclick="event.stopPropagation()">
                                    <input type="checkbox" class="custom-checkbox" id="cb-front"
                                        onchange="togglePart('front')">
                                </div>
                                <div
                                    class="w-12 h-12 bg-slate-100 rounded-lg flex items-center justify-center border border-slate-200 overflow-hidden relative shadow-inner">
                                    <img id="thumb-front" class="w-full h-full object-contain hidden">
                                    <i data-lucide="image" class="text-slate-400 w-5 h-5"></i>
                                </div>
                                <div class="flex-1">
                                    <span
                                        class="text-sm font-bold text-slate-700 block group-hover:text-blue-600 transition-colors">Frente</span>
                                    <span class="text-[11px] text-slate-400">Armação frontal</span>
                                </div>
                                <label class="btn-upload-large relative group/btn hover:scale-105"
                                    onclick="event.stopPropagation()">
                                    <i data-lucide="upload" class="w-5 h-5"></i>
                                    <input type="file" class="hidden" accept="image/png"
                                        onchange="uploadPart(this, 'front')">
                                    <div
                                        class="upload-status-dot absolute top-1.5 right-1.5 w-2 h-2 rounded-full hidden">
                                    </div>
                                </label>
                            </div>

                            <!-- Haste Esquerda -->
                            <div class="part-card p-3 rounded-xl cursor-pointer flex items-center gap-4 group"
                                id="card-left" onclick="selectPart('left')">
                                <div class="flex items-center justify-center" onclick="event.stopPropagation()">
                                    <input type="checkbox" class="custom-checkbox" id="cb-left"
                                        onchange="togglePart('left')">
                                </div>
                                <div
                                    class="w-12 h-12 bg-slate-100 rounded-lg flex items-center justify-center border border-slate-200 overflow-hidden relative shadow-inner">
                                    <img id="thumb-left" class="w-full h-full object-contain hidden">
                                    <i data-lucide="arrow-left" class="text-slate-400 w-5 h-5"></i>
                                </div>
                                <div class="flex-1">
                                    <span
                                        class="text-sm font-bold text-slate-700 block group-hover:text-blue-600 transition-colors">Haste
                                        Esq.</span>
                                    <span class="text-[11px] text-slate-400">Lateral esquerda</span>
                                </div>
                                <label class="btn-upload-large relative group/btn hover:scale-105"
                                    onclick="event.stopPropagation()">
                                    <i data-lucide="upload" class="w-5 h-5"></i>
                                    <input type="file" class="hidden" accept="image/png"
                                        onchange="uploadPart(this, 'left')">
                                    <div
                                        class="upload-status-dot absolute top-1.5 right-1.5 w-2 h-2 rounded-full hidden">
                                    </div>
                                </label>
                            </div>

                            <!-- Haste Direita -->
                            <div class="part-card p-3 rounded-xl cursor-pointer flex items-center gap-4 group"
                                id="card-right" onclick="selectPart('right')">
                                <div class="flex items-center justify-center" onclick="event.stopPropagation()">
                                    <input type="checkbox" class="custom-checkbox" id="cb-right"
                                        onchange="togglePart('right')">
                                </div>
                                <div
                                    class="w-12 h-12 bg-slate-100 rounded-lg flex items-center justify-center border border-slate-200 overflow-hidden relative shadow-inner">
                                    <img id="thumb-right" class="w-full h-full object-contain hidden">
                                    <i data-lucide="arrow-right" class="text-slate-400 w-5 h-5"></i>
                                </div>
                                <div class="flex-1">
                                    <span
                                        class="text-sm font-bold text-slate-700 block group-hover:text-blue-600 transition-colors">Haste
                                        Dir.</span>
                                    <span class="text-[11px] text-slate-400">Lateral direita</span>
                                </div>
                                <label class="btn-upload-large relative group/btn hover:scale-105"
                                    onclick="event.stopPropagation()">
                                    <i data-lucide="upload" class="w-5 h-5"></i>
                                    <input type="file" class="hidden" accept="image/png"
                                        onchange="uploadPart(this, 'right')">
                                    <div
                                        class="upload-status-dot absolute top-1.5 right-1.5 w-2 h-2 rounded-full hidden">
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Ajustes Finos (Oculto por padrão, movido via JS) -->
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hidden transition-all mt-3 mb-3"
                        id="smart-controls">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-base font-bold text-slate-800 flex items-center gap-2">
                                <i data-lucide="sliders" class="w-5 h-5 text-blue-600"></i> Ajustes Finos
                            </h2>

                            <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100"
                                id="auto-anchor-control">
                                <label class="text-xs font-semibold text-slate-600 cursor-pointer select-none"
                                    for="cb-auto-anchor">Auto-Ajuste</label>
                                <input type="checkbox" id="cb-auto-anchor"
                                    class="w-4 h-4 accent-blue-600 rounded cursor-pointer"
                                    onchange="toggleAutoAnchor(this.checked)" checked>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div id="ctrl-scale">
                                <div class="flex justify-between text-xs font-semibold text-slate-500 mb-2">
                                    <span>Tamanho / Escala</span>
                                    <span id="val-scale"
                                        class="bg-slate-100 px-2 py-0.5 rounded text-slate-700">1.0</span>
                                </div>
                                <input type="range" min="0.1" max="4.0" step="0.01" value="1.0" id="inp-scale"
                                    oninput="updateSmartParam('scale', this.value)">
                            </div>
                        </div>
                    </div>

                    <!-- DADOS DO PRODUTO (NOVO) -->
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                        <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2"><i data-lucide="tag"
                                class="w-4 h-4 text-blue-600"></i> Informações do Produto</h3>

                        <!-- Nome -->
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1">Nome ou Referência</label>
                            <input type="text" id="prod-name"
                                class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500 transition"
                                placeholder="Ex: Aviador 3000" oninput="updateWhatsAppLink()">
                        </div>

                        <!-- Categoria e Gerenciamento -->
                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <label class="block text-xs font-semibold text-slate-500">Categoria</label>
                                <button onclick="toggleCatManager()"
                                    class="text-[10px] text-blue-600 font-semibold hover:underline">Gerenciar</button>
                            </div>

                            <!-- Gerenciador de Categorias (Toggle) -->
                            <div id="cat-manager"
                                class="hidden mb-2 bg-slate-50 p-2 rounded-lg border border-slate-200">
                                <div class="flex flex-wrap gap-2 mb-2" id="cat-list-display">
                                    <!-- Tags inseridas via JS -->
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" id="new-cat-input"
                                        class="flex-1 text-xs border rounded px-2 py-1" placeholder="Nova Categoria...">
                                    <button onclick="addNewCategory()"
                                        class="bg-blue-600 text-white text-xs px-2 rounded hover:bg-blue-700">Add</button>
                                </div>
                            </div>

                            <select id="prod-category"
                                class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:border-blue-500 transition">
                                <!-- Populated by JS -->
                            </select>
                        </div>

                        <!-- Preço (Formatado) -->
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1">Preço (R$)</label>
                            <input type="text" id="prod-price" oninput="formatPriceInput(this)"
                                class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500 transition"
                                placeholder="0,00" inputmode="numeric">
                        </div>

                        <!-- WhatsApp Config moved to Config Menu -->

                        <!-- Link Compra -->
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1">URL Botão Comprar</label>
                            <input type="url" id="prod-link"
                                class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500 transition"
                                placeholder="https://...">
                        </div>
                    </div>

                    <!-- NOVO: Configuração Imagem de Capa (Vitrine) -->
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                        <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2">
                            <i data-lucide="image" class="w-4 h-4 text-blue-600"></i> Imagem de Capa (Vitrine)
                        </h3>
                        <div class="flex gap-4 mb-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="cover_source" value="front" checked
                                    onchange="toggleCoverMode()" class="accent-blue-600">
                                <span class="text-sm text-slate-600">Usar frente do óculos</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="cover_source" value="custom" onchange="toggleCoverMode()"
                                    class="accent-blue-600">
                                <span class="text-sm text-slate-600">Usar outra imagem</span>
                            </label>
                        </div>

                        <!-- Container Custom Upload -->
                        <div id="cover-custom-container" class="hidden space-y-3">
                            <label
                                class="block w-full border-2 border-dashed border-slate-300 rounded-xl p-4 text-center cursor-pointer hover:border-blue-500 transition bg-slate-50 hover:bg-blue-50">
                                <input type="file" class="hidden" accept="image/*" onchange="handleCoverUpload(this)">
                                <div class="flex flex-col items-center gap-2">
                                    <i data-lucide="upload-cloud" class="w-6 h-6 text-blue-500"></i>
                                    <span class="text-xs text-slate-500 font-semibold" id="cover-upload-text">Clique
                                        para enviar imagem</span>
                                </div>
                            </label>

                            <!-- Preview da Imagem Recortada (Final) -->
                            <div id="cover-preview-container" class="hidden">
                                <div
                                    class="w-full aspect-square bg-gray-100 rounded-lg overflow-hidden border border-slate-200 relative group flex items-center justify-center">
                                    <img id="final-cover-preview" class="w-full h-full object-cover">
                                    <button
                                        onclick="document.querySelector('#cover-custom-container input[type=file]').click()"
                                        class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center text-white font-bold transition-opacity">
                                        <span class="flex items-center gap-2"><i data-lucide="crop" class="w-4 h-4"></i>
                                            Editar</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Publicar -->
                    <button onclick="publishModel()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 flex items-center justify-center gap-2 active:scale-95 transition-all hover:-translate-y-0.5">
                        <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                        <span>Finalizar & Publicar</span>
                    </button>

                </div>
            </div>

            <!-- LIST VIEW CONTAINER (Novo Painel de Gestão) -->
            <div id="admin-list-view"
                class="hidden w-full max-w-6xl mx-auto p-6 bg-white rounded-2xl shadow-sm border border-slate-200">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="list" class="w-6 h-6 text-blue-600"></i> Gestão de Óculos
                        </h2>
                        <p class="text-sm text-slate-500 mt-1">Gerencie, edite ou remova os modelos da sua vitrine.</p>
                    </div>

                    <div class="flex flex-wrap gap-2 items-center w-full md:w-auto">
                        <!-- Busca -->
                        <div class="relative">
                            <i data-lucide="search"
                                class="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-400"></i>
                            <input type="text" id="admin-search-input" oninput="renderAdminProductList()"
                                placeholder="Buscar..."
                                class="pl-8 pr-2 py-2 bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 w-32 md:w-40">
                        </div>
                        <!-- Filtro de Categorias -->
                        <select id="admin-category-filter" onchange="renderAdminProductList()"
                            class="bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 w-28 md:w-32">
                            <option value="all">Todas</option>
                            <!-- JS popula aqui -->
                        </select>

                        <!-- NOVO BOTÃO DE MODELOS DIGITAIS (Atualizado) -->
                        <button onclick="openDigitalModels()" id="btn-open-ai-studio"
                            class="hidden bg-slate-900 hover:bg-slate-800 text-white font-bold py-2 px-3 rounded-lg shadow-md flex items-center gap-1.5 text-xs transition hover:-translate-y-0.5 whitespace-nowrap">
                            <i data-lucide="sparkles" class="w-3.5 h-3.5 text-blue-400"></i> IA
                        </button>

                        <!-- BOTÃO DNP (PUPILÔMETRO) -->
                        <button onclick="window.location.href='https://lopix.app/pupilometro'"
                            class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 rounded-lg shadow-md flex items-center gap-1.5 text-xs transition hover:-translate-y-0.5 whitespace-nowrap">
                            <i data-lucide="ruler" class="w-3.5 h-3.5"></i> DNP
                        </button>

                        <!-- NOVO: Botão Provador por Imagem (aparece quando ativo) -->
                        <button id="btn-open-image-provador"
                            onclick="window.open('/provador-imagem.html?store=' + encodeURIComponent(currentStoreData?.name || 'default'), '_blank')"
                            class="hidden bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg shadow-md flex items-center gap-1.5 text-xs transition hover:-translate-y-0.5 whitespace-nowrap">
                            <i data-lucide="image" class="w-3.5 h-3.5"></i> Provador Imagem
                        </button>

                        <button onclick="resetEditor()"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg shadow-md flex items-center gap-1.5 text-xs transition hover:-translate-y-0.5 whitespace-nowrap">
                            <i data-lucide="plus" class="w-3.5 h-3.5"></i> Novo
                        </button>
                    </div>
                </div>

                <!-- Lista de Produtos -->
                <div id="admin-products-list"
                    class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                    <!-- Injetado via JS -->
                    <div class="col-span-full py-12 flex justify-center">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>

            <!-- NOVO: CONFIG VIEW CONTAINER -->
            <div id="admin-config-view"
                class="hidden w-full max-w-2xl mx-auto p-6 bg-white rounded-2xl shadow-sm border border-slate-200">

                <!-- MENU PRINCIPAL -->
                <div id="config-main-menu">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="settings" class="w-6 h-6 text-blue-600"></i> Configuração
                        </h2>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        <button onclick="window.showConfigSite()"
                            class="flex items-center gap-4 p-4 bg-blue-50 border border-blue-100 rounded-xl hover:bg-blue-100 transition-all group text-left">
                            <div
                                class="w-12 h-12 bg-blue-600 text-white rounded-lg flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform">
                                <i data-lucide="layout-template" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-lg">Personalizar site</h3>
                                <p class="text-xs text-slate-500">Logo, Cores, Banner</p>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400 ml-auto"></i>
                        </button>

                        <button onclick="window.showConfigWhatsapp()"
                            class="flex items-center gap-4 p-4 bg-green-50 border border-green-100 rounded-xl hover:bg-green-100 transition-all group text-left">
                            <div
                                class="w-12 h-12 bg-green-600 text-white rounded-lg flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform">
                                <i class="fa-brands fa-whatsapp text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-lg">WhatsApp</h3>
                                <p class="text-xs text-slate-500">Link automático e mensagem</p>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400 ml-auto"></i>
                        </button>
                    </div>
                </div>

                <!-- SUB-MENU: SITE -->
                <div id="config-sub-site" class="hidden">
                    <div class="flex items-center gap-3 mb-6">
                        <button onclick="window.showConfigMain()"
                            class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 hover:bg-slate-200 transition">
                            <i data-lucide="arrow-left" class="w-4 h-4 text-slate-600"></i>
                        </button>
                        <h2 class="text-xl font-bold text-slate-800">Personalização da Vitrine</h2>
                    </div>

                    <div class="space-y-6">
                        <!-- Banner -->
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700">Banner do Topo</label>
                            <div
                                class="relative w-full h-32 bg-slate-100 rounded-lg overflow-hidden border border-slate-200 group">
                                <img id="config-banner-preview" src="https://i.ibb.co/m1J8Gdx/01.jpg"
                                    class="w-full h-full object-cover">
                                <label
                                    class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center text-white cursor-pointer transition-opacity">
                                    <i data-lucide="upload" class="w-6 h-6 mb-1"></i>
                                    <span class="text-xs font-bold">Alterar Banner</span>
                                    <input type="file" class="hidden" accept="image/*"
                                        onchange="handleConfigUpload(this, 'banner')">
                                </label>
                            </div>
                        </div>

                        <!-- Logo -->
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700">Logo da Loja</label>
                            <div class="flex items-center gap-4">
                                <div
                                    class="relative w-20 h-20 bg-slate-100 rounded-lg overflow-hidden border border-slate-200 group flex-shrink-0 flex items-center justify-center">
                                    <img id="config-logo-preview" class="w-full h-full object-contain p-2 hidden">
                                    <div id="config-logo-placeholder" class="text-slate-400 text-xs text-center">Sem
                                        Logo
                                    </div>
                                    <label
                                        class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center text-white cursor-pointer transition-opacity">
                                        <i data-lucide="upload" class="w-4 h-4"></i>
                                        <input type="file" class="hidden" accept="image/*"
                                            onchange="handleConfigUpload(this, 'logo')">
                                    </label>
                                </div>
                                <div class="text-xs text-slate-500">
                                    Recomendado: PNG transparente.<br>Substitui o nome da loja no topo.
                                </div>
                            </div>
                        </div>

                        <!-- Cores -->
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700">Cor dos Botões</label>
                            <div class="flex items-center gap-4">
                                <input type="color" id="config-color" value="#2563eb"
                                    class="w-12 h-12 rounded cursor-pointer border-0 p-0"
                                    oninput="updateConfigPreviewColor(this.value)">
                                <div class="flex-1">
                                    <div
                                        class="bg-slate-50 p-3 rounded border border-slate-100 flex gap-2 items-center">
                                        <span class="text-xs text-slate-500">Preview:</span>
                                        <button class="px-4 py-1.5 rounded text-white text-xs font-bold shadow-sm"
                                            id="btn-color-preview" style="background-color: #2563eb;">Botão
                                            Exemplo</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button onclick="saveStoreConfig()"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-md transition-all mt-4">
                            Salvar Alterações
                        </button>
                    </div>
                </div>

                <!-- SUB-MENU: WHATSAPP -->
                <div id="config-sub-whatsapp" class="hidden">
                    <div class="flex items-center gap-3 mb-6">
                        <button onclick="window.showConfigMain()"
                            class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 hover:bg-slate-200 transition">
                            <i data-lucide="arrow-left" class="w-4 h-4 text-slate-600"></i>
                        </button>
                        <h2 class="text-xl font-bold text-slate-800">Gerar Link WhatsApp</h2>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                            <label class="flex items-center gap-2 cursor-pointer mb-4">
                                <input type="checkbox" id="wa-auto-generate" class="accent-green-600 w-5 h-5"
                                    onchange="toggleWhatsAppConfig()">
                                <span class="text-sm font-bold text-slate-800">Ativar Link Automático</span>
                            </label>

                            <div id="wa-config-container" class="hidden space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-green-800 mb-1">Número do WhatsApp (DDD +
                                        Número)</label>
                                    <input type="text" id="wa-number"
                                        class="w-full border border-green-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-green-500 bg-white"
                                        placeholder="Ex: 5511999999999" oninput="handleWaParamChange()">
                                    <p class="text-[10px] text-green-600 mt-1">Apenas números. Ex: 5511999998888</p>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-green-800 mb-1">Mensagem Padrão</label>
                                    <input type="text" id="wa-message"
                                        class="w-full border border-green-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-green-500 bg-white"
                                        placeholder="Ex: Olá, tenho interesse no modelo"
                                        oninput="handleWaParamChange()">
                                    <p class="text-[10px] text-green-600 mt-1">Dica: Use {ref} para inserir o nome do
                                        óculos automaticamente.</p>
                                </div>
                            </div>
                        </div>

                        <button onclick="saveStoreConfig()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-md transition-all">
                            Salvar Configurações
                        </button>
                    </div>
                </div>
            </div>

            <div id="preview-panel" class="hidden"></div>
        </main>
    </div>

    <!-- ... (RESTANTE DO CÓDIGO HTML INTACTO: VIEW MASTER, PROVADOR, MODALS) ... -->
    <!-- ================================================================= -->
    <!-- VIEW 3: PAINEL MASTER (Gestão de Óticas) - NOVO -->
    <!-- ================================================================= -->
    <div id="view-master" class="fullscreen-overlay hidden-view flex flex-col bg-slate-50">
        <header class="w-full bg-slate-900 border-b border-slate-800 sticky top-0 z-20 shadow-md">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-500 p-2 rounded-lg">
                        <i data-lucide="shield" class="text-white w-5 h-5"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white tracking-tight">Painel <span
                                class="text-indigo-400">Master</span></h1>
                        <p class="text-xs text-slate-400">Gestão de Óticas e Acessos</p>
                    </div>
                </div>
                <button onclick="logoutMaster()"
                    class="text-sm font-semibold text-slate-400 hover:text-white transition">
                    Sair (Voltar ao Site)
                </button>
            </div>
        </header>

        <main class="flex-1 w-full max-w-5xl mx-auto p-8">
            <!-- Global Config (API Key) -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8">
                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2 mb-4">
                    <i data-lucide="server" class="w-5 h-5 text-indigo-600"></i> Configurações Globais
                </h2>
                <div class="flex gap-4 items-end">
                    <div class="flex-1">
                        <label class="block text-xs font-semibold text-slate-500 mb-1">API Key do Gemini
                            (Imagens)</label>
                        <input type="password" id="global-api-key"
                            class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500 font-mono"
                            placeholder="AIzaSy...">
                    </div>
                    <button onclick="saveGlobalSettings()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-sm transition-all text-sm">
                        Salvar Chave
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Form Criar/Editar Loja -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 h-fit">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2" id="master-form-title">
                            <i data-lucide="plus-circle" class="w-5 h-5 text-indigo-600"></i> Nova Ótica
                        </h2>
                    </div>

                    <!-- Trigger Button (Visible by Default) -->
                    <button onclick="toggleMasterForm(true)" id="btn-show-form"
                        class="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-3 rounded-lg border border-dashed border-slate-300 flex items-center justify-center gap-2 transition">
                        <i data-lucide="plus" class="w-4 h-4"></i> Adicionar Nova Ótica
                    </button>

                    <!-- Form Container (Hidden by Default) -->
                    <div id="master-store-form-container" class="space-y-4 hidden mt-4">
                        <input type="hidden" id="store-id-hidden"> <!-- ID para edição -->

                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1">Nome da Loja</label>
                            <input type="text" id="store-name"
                                class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"
                                placeholder="Ex: Ótica Visão">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1">Senha de Acesso
                                (Admin)</label>
                            <input type="text" id="store-pass"
                                class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"
                                placeholder="Senha para a loja">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 mb-1">Tempo de Uso</label>
                                <select id="store-plan"
                                    class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:border-indigo-500">
                                    <option value="7_days">7 Dias</option>
                                    <option value="1_month">1 Mês</option>
                                    <option value="12_months">1 Ano</option>
                                    <option value="unlimited">Ilimitado</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 mb-1">Status</label>
                                <select id="store-status"
                                    class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:border-indigo-500">
                                    <option value="active">Ativo</option>
                                    <option value="inactive">Desativado</option>
                                </select>
                            </div>
                        </div>

                        <!-- SESSÃO: TIPO DE PROVADOR -->
                        <div class="border-t border-slate-100 pt-4 mt-2">
                            <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                                <i data-lucide="eye" class="w-4 h-4 text-indigo-600"></i> Tipo de Provador
                            </h4>

                            <!-- Toggle Provador por Câmera -->
                            <div class="flex items-center gap-2 mb-2">
                                <input type="checkbox" id="store-allow-camera"
                                    class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer"
                                    onchange="handleProvadorToggle('camera')" checked>
                                <label for="store-allow-camera"
                                    class="text-sm text-slate-700 font-medium cursor-pointer select-none">Provador por
                                    Câmera (AR)</label>
                            </div>

                            <!-- Toggle Provador por Imagem -->
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="store-allow-image"
                                    class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer"
                                    onchange="handleProvadorToggle('image')">
                                <label for="store-allow-image"
                                    class="text-sm text-slate-700 font-medium cursor-pointer select-none">Provador por
                                    Imagem (Upload)</label>
                            </div>

                            <p class="text-xs text-slate-400 italic mt-2">* Apenas um provador pode ficar ativo por vez
                            </p>
                        </div>

                        <!-- SESSÃO: FUNCIONALIDADES EXTRAS (POR PROVADOR) -->
                        <div class="border-t border-slate-100 pt-4 mt-2">
                            <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-4 h-4 text-indigo-600"></i> Funcionalidades Extras
                            </h4>

                            <!-- Radio: Usar API Master ou Cliente -->
                            <div class="mb-4 p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <label class="block text-xs font-bold text-slate-500 mb-2">Integração API Gemini</label>
                                <div class="flex gap-4">
                                    <label class="flex items-center gap-2 text-sm cursor-pointer">
                                        <input type="radio" name="store-api-source" value="master" checked
                                            class="accent-indigo-600">
                                        <span class="text-slate-700">API Master</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-sm cursor-pointer">
                                        <input type="radio" name="store-api-source" value="client"
                                            class="accent-indigo-600">
                                        <span class="text-slate-700">API do Usuário</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Visagismo Digital -->
                            <div class="flex items-center gap-2 mb-2">
                                <input type="checkbox" id="store-allow-visagismo"
                                    class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer">
                                <label for="store-allow-visagismo"
                                    class="text-sm text-slate-700 font-medium cursor-pointer select-none">Visagismo</label>
                            </div>

                            <!-- DNP (Distância Naso-Pupilar) -->
                            <div class="flex items-center gap-2 mb-2">
                                <input type="checkbox" id="store-allow-dnp"
                                    class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer">
                                <label for="store-allow-dnp"
                                    class="text-sm text-slate-700 font-medium cursor-pointer select-none">DNP</label>
                            </div>

                            <!-- Modelos Digitais (IA) -->
                            <div class="flex items-center gap-2 mb-2">
                                <input type="checkbox" id="store-allow-ai"
                                    class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer"
                                    onchange="toggleAiLimitField()">
                                <label for="store-allow-ai"
                                    class="text-sm text-slate-700 font-medium cursor-pointer select-none">Modelos
                                    Digitais</label>
                            </div>

                            <!-- Campo de limite diário de gerações (visível apenas quando IA está ativa) -->
                            <div id="ai-limit-field" class="hidden ml-6 mt-2 mb-2">
                                <label class="block text-xs font-bold text-slate-500 mb-1">Limite diário de
                                    gerações</label>
                                <input type="number" id="store-ai-daily-limit"
                                    class="w-24 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"
                                    placeholder="5" min="1" max="100" value="5">
                                <span class="text-xs text-slate-400 ml-2">por dia</span>
                            </div>

                            <p class="text-xs text-slate-400 italic mt-2">* Funcionalidades disponíveis para ambos os
                                provadores</p>
                        </div>

                        <div class="flex gap-2 pt-2">
                            <button onclick="toggleMasterForm(false)"
                                class="flex-1 bg-gray-100 hover:bg-gray-200 text-slate-600 font-bold py-3 rounded-lg text-sm transition">Cancelar</button>
                            <button onclick="saveStore()" id="btn-save-store"
                                class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-md transition-all active:scale-95">
                                Criar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Lista de Lojas -->
                <div class="lg:col-span-2 space-y-4">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="users" class="w-5 h-5 text-indigo-600"></i> Óticas Cadastradas
                    </h2>

                    <div id="stores-list" class="space-y-3">
                        <!-- JS Injeta Lojas Aqui -->
                        <div class="text-center py-8 text-slate-400">Carregando lojas...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- VIEW 4: PROVADOR OVERLAY (Pop-up Fullscreen) - NOVO -->
    <div id="tryon-overlay" class="hidden">
        <!-- Header Provador -->
        <div class="absolute top-0 left-0 right-0 z-50 p-6 flex justify-between items-start pointer-events-none">
            <div
                class="bg-black/40 backdrop-blur-md px-5 py-2.5 rounded-full pointer-events-auto border border-white/10 shadow-lg">
                <span class="text-white font-bold text-sm tracking-wide" id="tryon-product-name">Provador Virtual</span>
            </div>
            <!-- Botão X mantido, mas a ação principal é o botão inferior agora -->
            <button onclick="closeTryOn(true)"
                class="w-10 h-10 bg-black/40 backdrop-blur-md rounded-full flex items-center justify-center text-white hover:bg-white/20 transition pointer-events-auto shadow-lg border border-white/10">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Área de Vídeo (Onde o canvas será movido) -->
        <div id="tryon-video-container">
            <!-- Canvas movido via JS -->
        </div>

        <!-- NOVO: Botões Inferiores (Outros + Comprar) -->
        <div id="tryon-footer" class="flex w-full px-6 pb-10 gap-4 justify-center pointer-events-none items-end">
            <button
                class="flex-1 pointer-events-auto bg-white/10 backdrop-blur-md border border-white/20 text-white font-bold py-3.5 rounded-full shadow-xl flex items-center justify-center gap-2.5 hover:bg-white/20 active:scale-95 transition-all uppercase tracking-wider text-xs"
                onclick="closeTryOn(true)">
                <i class="fa-solid fa-glasses text-base"></i>
                Outros
            </button>

            <a id="tryon-buy-btn" href="#" target="_blank"
                class="flex-1 pointer-events-auto bg-[#25D366] hover:bg-[#20bd5a] border border-white/10 text-white font-bold py-3.5 rounded-full shadow-xl shadow-green-900/20 flex items-center justify-center gap-2.5 active:scale-95 transition-all no-underline uppercase tracking-wider text-xs">
                <i class="fa-brands fa-whatsapp text-lg"></i>
                Comprar
            </a>
        </div>
    </div>

    <!-- ================================================================= -->
    <!-- VIEW 5: MODELOS DIGITAIS HIPER-REALISTAS (REDESENHADO) -->
    <!-- ================================================================= -->
    <div id="view-digital-models"
        class="fullscreen-overlay hidden-view flex flex-col bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 overflow-y-auto">

        <!-- Header Fixo com Glassmorphism -->
        <header class="sticky top-0 z-30 bg-slate-900/80 backdrop-blur-xl border-b border-white/5">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/25">
                        <i data-lucide="sparkles" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h2 class="text-lg sm:text-xl font-bold text-white">Modelos Digitais</h2>
                        <p class="text-[10px] sm:text-xs text-slate-400">Geração de imagens com IA</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Contador de Limite -->
                    <div
                        class="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-white/5 rounded-full border border-white/10">
                        <i data-lucide="zap" class="w-3.5 h-3.5 text-amber-400"></i>
                        <span class="text-xs font-semibold text-slate-300" id="gen-limit-counter">0/5 hoje</span>
                    </div>
                    <button onclick="closeDigitalModels()"
                        class="w-9 h-9 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-slate-400 hover:text-white transition border border-white/10">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Contador Mobile -->
        <div class="sm:hidden flex justify-center py-3 bg-slate-900/50">
            <div class="flex items-center gap-2 px-4 py-2 bg-white/5 rounded-full border border-white/10">
                <i data-lucide="zap" class="w-3.5 h-3.5 text-amber-400"></i>
                <span class="text-xs font-semibold text-slate-300" id="gen-limit-counter-mobile">0/5 gerações
                    hoje</span>
            </div>
        </div>

        <!-- Progress Steps Indicator -->
        <div class="max-w-2xl mx-auto px-4 py-4" id="ai-progress-bar">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2" id="ai-prog-step-1">
                    <div
                        class="w-8 h-8 rounded-full bg-blue-600 text-white text-sm font-bold flex items-center justify-center shadow-lg shadow-blue-600/30">
                        1</div>
                    <span class="text-xs font-medium text-white hidden sm:inline">Upload</span>
                </div>
                <div class="flex-1 h-0.5 mx-2 sm:mx-4 bg-slate-700 rounded-full overflow-hidden">
                    <div class="h-full bg-blue-500 transition-all duration-500" id="ai-progress-line-1"
                        style="width: 0%"></div>
                </div>
                <div class="flex items-center gap-2" id="ai-prog-step-2">
                    <div
                        class="w-8 h-8 rounded-full bg-slate-700 text-slate-400 text-sm font-bold flex items-center justify-center">
                        2</div>
                    <span class="text-xs font-medium text-slate-500 hidden sm:inline">Modo</span>
                </div>
                <div class="flex-1 h-0.5 mx-2 sm:mx-4 bg-slate-700 rounded-full overflow-hidden">
                    <div class="h-full bg-blue-500 transition-all duration-500" id="ai-progress-line-2"
                        style="width: 0%"></div>
                </div>
                <div class="flex items-center gap-2" id="ai-prog-step-3">
                    <div
                        class="w-8 h-8 rounded-full bg-slate-700 text-slate-400 text-sm font-bold flex items-center justify-center">
                        3</div>
                    <span class="text-xs font-medium text-slate-500 hidden sm:inline">Configurar</span>
                </div>
                <div class="flex-1 h-0.5 mx-2 sm:mx-4 bg-slate-700 rounded-full overflow-hidden">
                    <div class="h-full bg-blue-500 transition-all duration-500" id="ai-progress-line-3"
                        style="width: 0%"></div>
                </div>
                <div class="flex items-center gap-2" id="ai-prog-step-result">
                    <div
                        class="w-8 h-8 rounded-full bg-slate-700 text-slate-400 text-sm font-bold flex items-center justify-center">
                        <i data-lucide="check" class="w-4 h-4"></i>
                    </div>
                    <span class="text-xs font-medium text-slate-500 hidden sm:inline">Resultado</span>
                </div>
            </div>
        </div>

        <!-- Main Content Container -->
        <main class="flex-1 max-w-2xl w-full mx-auto px-4 sm:px-6 pb-8" id="ai-steps-container">

            <!-- Loading Overlay -->
            <div id="ai-loading"
                class="fixed inset-0 bg-slate-900/95 z-50 flex flex-col items-center justify-center hidden backdrop-blur-sm">
                <div class="relative mb-6">
                    <div class="w-20 h-20 border-4 border-blue-500/20 border-t-blue-500 rounded-full animate-spin">
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <i data-lucide="sparkles" class="w-8 h-8 text-blue-400 animate-pulse"></i>
                    </div>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Gerando Imagem...</h3>
                <p class="text-sm text-slate-400 max-w-xs text-center">A IA está processando sua imagem. Isso pode levar
                    alguns segundos.</p>
            </div>

            <!-- PASSO 1: UPLOAD ARMAÇÃO -->
            <div id="ai-step-1" class="ai-step active flex flex-col items-center py-8 sm:py-12 animate-fade-in">
                <div class="text-center mb-8">
                    <div
                        class="inline-flex items-center gap-2 px-4 py-2 bg-blue-500/10 text-blue-400 text-xs font-bold uppercase tracking-wider rounded-full border border-blue-500/20 mb-4">
                        <i data-lucide="upload" class="w-3.5 h-3.5"></i>
                        Passo 1 de 3
                    </div>
                    <h3 class="text-2xl sm:text-3xl font-bold text-white mb-2">Envie a imagem do óculos</h3>
                    <p class="text-slate-400 text-sm max-w-sm mx-auto">Faça upload de uma imagem clara do óculos que
                        deseja usar</p>
                </div>

                <div class="w-full max-w-md mb-6">
                    <label class="group cursor-pointer block">
                        <input type="file" class="hidden" accept="image/png, image/jpeg, image/webp"
                            onchange="handleAiFrameUpload(this)">
                        <div
                            class="relative w-full aspect-[4/3] rounded-2xl border-2 border-dashed border-slate-600 bg-slate-800/50 hover:border-blue-500 hover:bg-slate-800 transition-all overflow-hidden">
                            <img id="ai-frame-preview"
                                class="absolute inset-0 w-full h-full object-contain p-6 hidden z-10">
                            <div class="absolute inset-0 flex flex-col items-center justify-center gap-4 text-slate-400 group-hover:text-blue-400 transition-colors p-6"
                                id="ai-frame-placeholder">
                                <div
                                    class="w-20 h-20 rounded-2xl bg-slate-700/50 flex items-center justify-center group-hover:scale-110 group-hover:bg-blue-500/20 transition-all">
                                    <i data-lucide="image-plus" class="w-10 h-10"></i>
                                </div>
                                <div class="text-center">
                                    <p class="font-semibold text-base mb-1">Clique ou arraste a imagem</p>
                                    <p class="text-xs text-slate-500">PNG, JPG ou WEBP</p>
                                </div>
                            </div>
                        </div>
                    </label>
                </div>

                <button id="btn-ai-next-1" disabled onclick="goToAiStep(2)"
                    class="w-full max-w-md bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 disabled:from-slate-700 disabled:to-slate-700 disabled:cursor-not-allowed text-white font-bold py-4 px-8 rounded-xl shadow-lg shadow-blue-600/25 disabled:shadow-none transition-all flex items-center justify-center gap-2 text-base">
                    Continuar <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- PASSO 2: SELEÇÃO DE MODO -->
            <div id="ai-step-2" class="ai-step flex flex-col items-center py-8 sm:py-12">
                <div class="text-center mb-8">
                    <div
                        class="inline-flex items-center gap-2 px-4 py-2 bg-blue-500/10 text-blue-400 text-xs font-bold uppercase tracking-wider rounded-full border border-blue-500/20 mb-4">
                        <i data-lucide="settings-2" class="w-3.5 h-3.5"></i>
                        Passo 2 de 3
                    </div>
                    <h3 class="text-2xl sm:text-3xl font-bold text-white mb-2">Como você quer gerar?</h3>
                    <p class="text-slate-400 text-sm">Escolha entre criar um modelo ou usar sua foto</p>
                </div>

                <div class="grid grid-cols-1 gap-4 w-full max-w-lg mb-6">
                    <!-- Opção 1: Modelo IA -->
                    <button onclick="selectAiMode('model')"
                        class="group w-full bg-slate-800/60 border border-slate-700 hover:border-blue-500 rounded-2xl p-5 transition-all text-left flex items-center gap-5 hover:bg-slate-800">
                        <div
                            class="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-500 to-blue-600 flex items-center justify-center shadow-lg flex-shrink-0 group-hover:scale-110 transition-transform">
                            <i data-lucide="bot" class="w-7 h-7 text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-base font-bold text-white group-hover:text-blue-400 transition-colors">Criar
                                Modelo IA</h4>
                            <p class="text-xs text-slate-400 mt-0.5">Gere uma pessoa fictícia usando o óculos</p>
                        </div>
                        <i data-lucide="chevron-right"
                            class="w-5 h-5 text-slate-600 group-hover:text-blue-400 flex-shrink-0 transition-colors"></i>
                    </button>

                    <!-- Opção 2: Foto Própria -->
                    <button onclick="selectAiMode('custom')"
                        class="group w-full bg-slate-800/60 border border-slate-700 hover:border-emerald-500 rounded-2xl p-5 transition-all text-left flex items-center gap-5 hover:bg-slate-800">
                        <div
                            class="w-14 h-14 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center shadow-lg flex-shrink-0 group-hover:scale-110 transition-transform">
                            <i data-lucide="user" class="w-7 h-7 text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-base font-bold text-white group-hover:text-emerald-400 transition-colors">
                                Usar Minha Foto</h4>
                            <p class="text-xs text-slate-400 mt-0.5">Aplique o óculos em uma foto sua</p>
                        </div>
                        <i data-lucide="chevron-right"
                            class="w-5 h-5 text-slate-600 group-hover:text-emerald-400 flex-shrink-0 transition-colors"></i>
                    </button>
                </div>

                <button onclick="goToAiStep(1)"
                    class="text-slate-500 text-sm hover:text-white transition flex items-center gap-2 mt-2">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Voltar
                </button>
            </div>

            <!-- PASSO 3: DETALHES & RENDER -->
            <div id="ai-step-3" class="ai-step flex flex-col py-8 sm:py-10">
                <div class="text-center mb-6">
                    <div
                        class="inline-flex items-center gap-2 px-4 py-2 bg-blue-500/10 text-blue-400 text-xs font-bold uppercase tracking-wider rounded-full border border-blue-500/20 mb-4">
                        <i data-lucide="sliders" class="w-3.5 h-3.5"></i>
                        Passo 3 de 3
                    </div>
                    <h3 class="text-xl sm:text-2xl font-bold text-white mb-1" id="step-3-title">Personalize a geração
                    </h3>
                    <p class="text-slate-400 text-sm">Configure os detalhes da imagem</p>
                </div>

                <!-- Preview do Óculos selecionado -->
                <div class="w-full bg-slate-800/40 rounded-xl p-4 mb-6 border border-slate-700/50">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-16 h-16 rounded-lg bg-slate-900/60 overflow-hidden flex-shrink-0 border border-slate-700">
                            <img id="ai-frame-mini-preview" class="w-full h-full object-contain p-2" src="">
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-slate-500 uppercase tracking-wider mb-0.5">Óculos selecionado</p>
                            <p class="text-sm font-semibold text-white truncate">Imagem carregada</p>
                        </div>
                        <button onclick="goToAiStep(1)"
                            class="text-xs text-blue-400 hover:text-blue-300 font-medium">Trocar</button>
                    </div>
                </div>

                <!-- Upload Adicional (Só para modo Custom) -->
                <div id="ai-custom-upload-area" class="w-full hidden mb-6">
                    <label class="block text-xs font-bold text-slate-400 mb-3 uppercase tracking-wider">Sua Foto</label>
                    <label class="group cursor-pointer block">
                        <input type="file" class="hidden" accept="image/*" onchange="handleAiFaceUpload(this)">
                        <div
                            class="flex items-center gap-4 p-4 bg-slate-800/40 border border-dashed border-slate-600 hover:border-emerald-500 rounded-xl transition-all">
                            <div
                                class="w-20 h-20 rounded-xl bg-slate-900/60 overflow-hidden flex-shrink-0 flex items-center justify-center border border-slate-700 relative">
                                <img id="ai-face-preview" class="absolute inset-0 w-full h-full object-cover hidden">
                                <i data-lucide="user-plus"
                                    class="w-8 h-8 text-slate-500 group-hover:text-emerald-400 transition-colors"
                                    id="ai-face-icon"></i>
                            </div>
                            <div class="flex-1">
                                <p
                                    class="font-semibold text-white text-sm mb-1 group-hover:text-emerald-400 transition-colors">
                                    Clique para enviar sua foto</p>
                                <ul class="text-xs text-slate-500 space-y-0.5">
                                    <li>• Rosto de frente, boa iluminação</li>
                                    <li>• Preferencialmente sem óculos</li>
                                </ul>
                            </div>
                        </div>
                    </label>
                </div>

                <!-- Inputs de Texto -->
                <div class="w-full space-y-5">
                    <div id="ai-model-desc-group">
                        <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Descrição da
                            Pessoa</label>
                        <input type="text" id="ai-prompt-model"
                            class="w-full px-4 py-3.5 rounded-xl bg-slate-800/60 border border-slate-700 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 text-white text-sm placeholder-slate-500 outline-none transition-all"
                            placeholder="Ex: Mulher jovem, cabelo castanho, pele clara...">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Cenário /
                            Ambiente</label>
                        <input type="text" id="ai-prompt-scene"
                            class="w-full px-4 py-3.5 rounded-xl bg-slate-800/60 border border-slate-700 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 text-white text-sm placeholder-slate-500 outline-none transition-all"
                            placeholder="Ex: Escritório moderno, praia, estúdio...">
                    </div>

                    <label
                        class="flex items-center gap-3 cursor-pointer group p-3 bg-slate-800/30 rounded-xl border border-slate-700/50 hover:border-slate-600 transition-colors">
                        <div class="relative">
                            <input type="checkbox" id="ai-keep-bg" class="sr-only peer" onchange="toggleAiSceneInput()">
                            <div
                                class="w-11 h-6 bg-slate-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                            </div>
                        </div>
                        <span class="text-sm text-slate-300 group-hover:text-white transition">Manter fundo original da
                            foto</span>
                    </label>
                </div>

                <button id="btn-generate-ai" onclick="generateAIImage()"
                    class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 disabled:from-slate-700 disabled:to-slate-700 disabled:cursor-not-allowed text-white font-bold py-4 px-8 rounded-xl shadow-lg shadow-blue-600/25 disabled:shadow-none transition-all flex items-center justify-center gap-2 text-base mt-8">
                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                    Gerar Imagem
                </button>

                <button onclick="goToAiStep(2)"
                    class="text-slate-500 text-sm hover:text-white transition flex items-center gap-2 mt-4 mx-auto">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Voltar
                </button>
            </div>

            <!-- PASSO 4: RESULTADO -->
            <div id="ai-step-result" class="ai-step flex flex-col items-center py-8 sm:py-10">
                <div class="text-center mb-6">
                    <div
                        class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-500/10 text-emerald-400 text-xs font-bold uppercase tracking-wider rounded-full border border-emerald-500/20 mb-4">
                        <i data-lucide="check-circle" class="w-3.5 h-3.5"></i>
                        Imagem Gerada
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-1">Resultado</h3>
                    <p class="text-slate-400 text-sm">Sua imagem está pronta para download</p>
                </div>

                <!-- Container da Imagem Resultado (1080x1350 aspect ratio) -->
                <div class="w-full max-w-sm mx-auto mb-6">
                    <div class="relative w-full bg-slate-800/60 rounded-2xl overflow-hidden border border-slate-700 shadow-2xl"
                        style="aspect-ratio: 1080/1350;">
                        <img id="ai-result-image" class="w-full h-full object-contain">
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="w-full max-w-sm space-y-3">
                    <button onclick="downloadAiImage()"
                        class="w-full bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white font-bold py-4 px-6 rounded-xl shadow-lg shadow-emerald-600/25 transition-all flex items-center justify-center gap-2 text-base">
                        <i data-lucide="download" class="w-5 h-5"></i> Baixar Imagem (1080x1350)
                    </button>

                    <div class="flex gap-3">
                        <button onclick="resetAiProcess()"
                            class="flex-1 py-3 rounded-xl bg-slate-800 border border-slate-700 text-slate-300 hover:bg-slate-700 hover:text-white transition font-medium flex items-center justify-center gap-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i> Nova Geração
                        </button>
                        <button onclick="closeDigitalModels()"
                            class="flex-1 py-3 rounded-xl bg-blue-600/20 border border-blue-500/30 text-blue-400 hover:bg-blue-600/30 transition font-medium">
                            Concluir
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- NOVO: MODAL DE CROP (AJUSTE DE IMAGEM) -->
    <div id="crop-modal" class="fixed inset-0 z-[10001] hidden modal-overlay flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl flex flex-col gap-4">
            <h3 class="text-lg font-bold text-slate-800">Ajustar Imagem de Capa</h3>

            <div class="relative w-full aspect-square bg-slate-100 rounded-lg overflow-hidden cursor-move touch-none border border-slate-200"
                id="crop-area">
                <!-- Canvas desenhado via JS -->
                <canvas id="crop-canvas" class="w-full h-full"></canvas>
            </div>

            <div class="flex items-center gap-4">
                <i data-lucide="zoom-in" class="w-5 h-5 text-slate-400"></i>
                <input type="range" min="1" max="3" step="0.05" value="1" id="crop-zoom" class="flex-1 accent-blue-600">
            </div>

            <div class="flex gap-3 mt-2">
                <button onclick="closeCropModal()"
                    class="flex-1 bg-slate-100 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-200">Cancelar</button>
                <button onclick="confirmCrop()"
                    class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE SUCESSO (Configurações) -->
    <div id="success-modal" class="fixed inset-0 z-[10000] hidden modal-overlay flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full shadow-2xl text-center transform transition-all scale-100">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="check" class="text-green-600 w-8 h-8"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Sucesso!</h3>
            <p class="text-slate-500 mb-6">Suas configurações foram salvas com sucesso!</p>
            <button onclick="closeSuccessModalAndGoToVitrine()"
                class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition shadow-sm">
                OK
            </button>
        </div>
    </div>

    <!-- MODAL DE LOGIN (Universal: Admin & Master) -->
    <div id="login-modal" class="fixed inset-0 z-[10000] hidden modal-overlay flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full shadow-2xl transform transition-all scale-100">
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3"
                    id="login-icon-bg">
                    <i class="fa-solid fa-lock text-blue-600 text-lg" id="login-icon"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800" id="login-title">Acesso Restrito</h2>
                <p class="text-sm text-gray-500" id="login-desc">Digite a senha de acesso</p>
            </div>

            <input type="password" id="input-pass"
                class="w-full border border-gray-300 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none text-center text-lg"
                placeholder="Senha">
            <input type="hidden" id="login-type" value="admin"> <!-- admin | master -->

            <div class="flex gap-3">
                <button onclick="closeLogin()"
                    class="flex-1 bg-gray-100 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-200 transition">Cancelar</button>
                <button onclick="processLogin()"
                    class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">Entrar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIRMAÇÃO (Para substituir o confirm() nativo) -->
    <div id="confirm-modal" class="fixed inset-0 z-[10000] hidden modal-overlay flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full shadow-2xl text-center">
            <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <i data-lucide="alert-triangle" class="text-yellow-600 w-6 h-6"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-900 mb-2">Confirmação</h3>
            <p class="text-gray-500 mb-6" id="confirm-message">Tem certeza?</p>
            <div class="flex gap-3">
                <button id="btn-confirm-cancel"
                    class="flex-1 bg-gray-100 text-gray-700 font-bold py-2.5 rounded-lg hover:bg-gray-200">Não</button>
                <button id="btn-confirm-yes"
                    class="flex-1 bg-blue-600 text-white font-bold py-2.5 rounded-lg hover:bg-blue-700">Sim</button>
            </div>
        </div>
    </div>

    <!-- === MODAL VISAGISMO DIGITAL (LOPIX - CÂMERA) === -->
    <div id="visagism-modal" class="fixed inset-0 z-[10000] hidden modal-overlay flex items-center justify-center">
        <div class="bg-white rounded-2xl max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-gray-100 shrink-0">
                <div>
                    <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                        <i data-lucide="scan-face" class="w-6 h-6"></i> Visagismo Inteligente
                    </h3>
                    <p class="text-xs text-gray-500 mt-1">Descubra o óculos ideal para você</p>
                </div>
                <button onclick="closeVisagismModal()"
                    class="p-2 hover:bg-gray-100 rounded-full text-gray-500 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-6">

                <!-- PERGUNTA 1: PREFERÊNCIA (Gênero) -->
                <div id="vis-step-q1" class="text-center max-w-md mx-auto w-full">
                    <h4 class="text-2xl font-bold mb-2">Qual sua preferência?</h4>
                    <p class="text-gray-500 text-sm mb-8">Selecione para quem são os óculos.</p>

                    <div class="space-y-3">
                        <button onclick="handleVisQuestion1('masculino')"
                            class="w-full flex items-center justify-between px-6 py-4 bg-gray-50 border border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all group">
                            <span class="font-bold text-lg">Óculos Masculino</span>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400 group-hover:text-blue-600"></i>
                        </button>
                        <button onclick="handleVisQuestion1('feminino')"
                            class="w-full flex items-center justify-between px-6 py-4 bg-gray-50 border border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all group">
                            <span class="font-bold text-lg">Óculos Feminino</span>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400 group-hover:text-blue-600"></i>
                        </button>
                    </div>
                </div>

                <!-- PERGUNTA 2: TIPO (Grau/Sol) -->
                <div id="vis-step-q2" class="hidden text-center max-w-md mx-auto w-full">
                    <h4 class="text-2xl font-bold mb-2">O que você procura?</h4>
                    <p class="text-gray-500 text-sm mb-8">Filtraremos as melhores opções.</p>

                    <div class="space-y-3">
                        <button onclick="handleVisQuestion2('grau')"
                            class="w-full flex items-center justify-between px-6 py-4 bg-gray-50 border border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all group">
                            <div class="flex items-center gap-3">
                                <i data-lucide="glasses" class="w-6 h-6"></i>
                                <span class="font-bold text-lg">Óculos de Grau</span>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400 group-hover:text-blue-600"></i>
                        </button>
                        <button onclick="handleVisQuestion2('solar')"
                            class="w-full flex items-center justify-between px-6 py-4 bg-gray-50 border border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all group">
                            <div class="flex items-center gap-3">
                                <i data-lucide="sun" class="w-6 h-6"></i>
                                <span class="font-bold text-lg">Óculos de Sol</span>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400 group-hover:text-blue-600"></i>
                        </button>
                    </div>
                    <button onclick="backToQ1()"
                        class="mt-8 text-sm text-gray-400 hover:text-black underline">Voltar</button>
                </div>

                <!-- CÂMERA VISAGISMO (VÍDEO) -->
                <div id="vis-camera-screen" class="hidden flex flex-col items-center justify-center h-full w-full py-4">
                    <h3 class="text-lg font-bold text-gray-900 mb-4 shrink-0">Posicione seu rosto</h3>

                    <!-- Container de Vídeo Responsivo -->
                    <div class="relative w-full max-w-sm bg-black rounded-xl overflow-hidden mb-4 shadow-lg shrink-0"
                        style="aspect-ratio: 3/4; max-height: 50vh;">
                        <video id="vis-webcam-video" class="w-full h-full object-cover transform -scale-x-100" autoplay
                            playsinline></video>
                    </div>

                    <!-- Botões de Ação -->
                    <div class="flex gap-3 w-full max-w-sm shrink-0">
                        <button onclick="closeVisagismCamera()"
                            class="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-50 rounded-xl bg-gray-100">Voltar</button>
                        <button onclick="captureVisagismPhoto()"
                            class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                            <i data-lucide="scan-face" class="w-4 h-4"></i> Analisar
                        </button>
                    </div>
                    <!-- Input Nativo Oculto para Visagismo (Fallback) -->
                    <input type="file" id="vis-native-camera-input" accept="image/*" capture="user" class="hidden"
                        onchange="handleVisagismNativeUpload(this)">
                </div>

                <!-- STEP LOADING -->
                <div id="vis-step-loading" class="hidden flex flex-col items-center justify-center py-20 text-center">
                    <div class="w-16 h-16 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin mb-4">
                    </div>
                    <h4 class="font-bold text-lg">Analisando traços faciais...</h4>
                    <p class="text-sm text-gray-500">Mapeando geometria do rosto</p>
                </div>

                <!-- STEP RESULT -->
                <div id="vis-step-result" class="hidden">
                    <div class="flex flex-col md:flex-row gap-8 mb-8">
                        <!-- Preview da Imagem com Mesh -->
                        <div
                            class="w-full md:w-1/3 relative rounded-xl overflow-hidden bg-black aspect-[3/4] shadow-lg flex items-center justify-center">
                            <img id="vis-preview-img" class="w-full h-full object-contain opacity-80">
                            <canvas id="vis-mesh-canvas"
                                class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
                        </div>

                        <!-- Análise e Explicação -->
                        <div class="w-full md:w-2/3">
                            <div class="bg-blue-50 p-6 rounded-2xl mb-6 border border-blue-100">
                                <h4 class="font-bold text-blue-900 mb-2 flex items-center gap-2">
                                    <i data-lucide="info" class="w-4 h-4"></i> Características do seu rosto
                                </h4>
                                <p id="vis-analysis-text" class="text-sm text-blue-800 leading-relaxed">
                                    Aguardando análise...
                                </p>
                            </div>

                            <h4 class="font-bold text-lg mb-4 flex items-center gap-2">
                                <i data-lucide="glasses" class="w-5 h-5"></i> Óculos Recomendados
                            </h4>
                            <div id="vis-recommendations-grid" class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- JS Populated -->
                            </div>
                        </div>
                    </div>

                    <div class="text-center pt-6 border-t border-gray-100">
                        <button onclick="resetVisagism()"
                            class="text-sm text-gray-500 hover:text-black font-bold underline">Nova Análise</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>
    <!-- Hidden Root for React Compliance -->
    <div id="root" style="display: none;"></div>

    <script>
        // Inicializa ícones
        lucide.createIcons();
        let apiKey = ""; // API Key agora é dinâmica e carregada do Firebase

        // --- GLOBAL & PARAMS ---
        const urlParams = new URLSearchParams(window.location.search);
        const CURRENT_STORE_PARAM = urlParams.get('store');
        let CURRENT_STORE_ID = null;
        let currentStoreData = null;
        let lastEditedProductId = null;

        // --- FILTROS VITRINE ---
        let currentVitrineCategory = 'all';

        // --- SEGURANÇA & NAVEGAÇÃO ---
        let logoClicks = 0;
        let logoTimer;
        let masterClicks = 0;
        let masterTimer;

        const MASTER_PASS = "master";
        const DEFAULT_ADMIN_PASS = "admin";

        // ... (Mantendo funções de inicialização de loja intactas) ...
        async function initStoreContext() {
            // Primeiro: Carrega configurações globais (API Key)
            await fetchGlobalSettings();

            if (CURRENT_STORE_PARAM) {
                try {
                    let doc = await db.collection('stores').doc(CURRENT_STORE_PARAM).get();
                    if (!doc.exists) {
                        const snap = await db.collection('stores').where('name', '==', CURRENT_STORE_PARAM).limit(1).get();
                        if (!snap.empty) { doc = snap.docs[0]; }
                    }
                    if (doc.exists) {
                        currentStoreData = doc.data();
                        CURRENT_STORE_ID = doc.id;
                        if (currentStoreData.active === false) {
                            document.getElementById('blocked-screen').classList.remove('hidden');
                            document.getElementById('view-vitrine').classList.add('hidden-view');
                            return;
                        }
                        if (currentStoreData.expiresAt && currentStoreData.expiresAt !== 'unlimited') {
                            if (Date.now() > currentStoreData.expiresAt) {
                                showToast("O acesso desta loja expirou. Contate o administrador.", "error");
                                return;
                            }
                        }
                        document.getElementById('store-label').innerHTML = `<span class="text-blue-600 font-bold">${currentStoreData.name}</span>`;
                        document.getElementById('admin-subtitle').innerText = `Gestão: ${currentStoreData.name}`;
                        document.title = `${currentStoreData.name} - Vitrine Virtual`;

                        // NOVO: Aplicar configurações visuais salvas
                        if (currentStoreData.settings) {
                            applyStoreSettings(currentStoreData.settings);
                        }

                        // NOVO: Controle de Acesso ao Botão de IA
                        const btnAi = document.getElementById('btn-open-ai-studio');
                        if (currentStoreData.allowAi === true) {
                            btnAi.classList.remove('hidden');
                            btnAi.classList.add('flex');
                        } else {
                            btnAi.classList.add('hidden');
                            btnAi.classList.remove('flex');
                        }

                        // NOVO: Controle de Acesso ao Botão de Provador por Imagem
                        const btnImageProvador = document.getElementById('btn-open-image-provador');
                        if (currentStoreData.allowImage === true) {
                            btnImageProvador.classList.remove('hidden');
                            btnImageProvador.classList.add('flex');
                        } else {
                            btnImageProvador.classList.add('hidden');
                            btnImageProvador.classList.remove('flex');
                        }

                        // NOVO: Controle de Visagismo na Vitrine
                        const visagismoContainer = document.getElementById('vitrine-visagismo-container');
                        if (visagismoContainer) {
                            if (currentStoreData.allowVisagismo === true) {
                                visagismoContainer.classList.remove('hidden');
                            } else {
                                visagismoContainer.classList.add('hidden');
                            }
                        }

                    } else {
                        showToast("Loja não encontrada. Carregando padrão.", "error");
                    }
                } catch (e) { console.error("Erro ao carregar loja", e); }
            }
            renderVitrine();
        }

        // NOVO: Função para buscar API Key global
        async function fetchGlobalSettings() {
            try {
                const doc = await db.collection('settings').doc('global').get();
                if (doc.exists && doc.data().apiKey) {
                    apiKey = doc.data().apiKey;
                    // Popula o campo no painel master se ele estiver visível (apenas para referência)
                    document.getElementById('global-api-key').value = apiKey;
                }
            } catch (e) { console.error("Erro ao carregar config global", e); }
        }

        // NOVO: Salvar API Key Global
        async function saveGlobalSettings() {
            const key = document.getElementById('global-api-key').value.trim();
            if (!key) { showToast("Insira uma chave válida", "error"); return; }
            try {
                await db.collection('settings').doc('global').set({ apiKey: key }, { merge: true });
                apiKey = key;
                showToast("Chave API salva com sucesso!", "success");
            } catch (e) {
                showToast("Erro ao salvar chave", "error");
            }
        }

        // NOVO: Toggle Form Master
        function toggleMasterForm(show) {
            const formContainer = document.getElementById('master-store-form-container');
            const btnShow = document.getElementById('btn-show-form');
            if (show) {
                formContainer.classList.remove('hidden');
                btnShow.classList.add('hidden');
                resetMasterForm(); // Limpa se estiver abrindo novo
            } else {
                formContainer.classList.add('hidden');
                btnShow.classList.remove('hidden');
            }
        }

        // NOVO: Função para aplicar estilos visuais
        function applyStoreSettings(settings) {
            if (settings.banner) {
                const banner = document.getElementById('store-banner');
                // Força reload da imagem para evitar cache ou sobreposição
                banner.src = "";
                setTimeout(() => { banner.src = settings.banner; }, 10);
                document.getElementById('config-banner-preview').src = settings.banner;
            }
            if (settings.logo) {
                document.getElementById('default-logo-content').classList.add('hidden');
                const logoImg = document.getElementById('custom-logo-img');
                logoImg.src = settings.logo;
                logoImg.classList.remove('hidden');

                // Atualizar preview no config
                document.getElementById('config-logo-preview').src = settings.logo;
                document.getElementById('config-logo-preview').classList.remove('hidden');
                document.getElementById('config-logo-placeholder').classList.add('hidden');
            }
            if (settings.color) {
                const styleEl = document.getElementById('store-custom-styles');
                styleEl.innerHTML = `
                    .btn-store-primary, 
                    .bg-blue-600, 
                    .hover\\:bg-blue-600:hover, 
                    .text-blue-600 { 
                        /* Sobrescreve classes tailwind dinamicamente onde possível, ou usa classes especificas */
                    }
                    /* Aplicando via seletores específicos para garantir */
                    #whatsapp-btn { background-color: ${settings.color} !important; border-color: ${settings.color} !important; }
                    .glass-card button:first-child { background-color: ${settings.color} !important; color: white !important; } /* Botão Provador era preto, agora cor da loja? Ou manter preto? O prompt diz "todos os botões". Vou aplicar ao provador. */
                    .glass-card button:first-child:hover { opacity: 0.9; }
                    
                    /* Filtro ativo */
                    #vitrine-category-filters button.bg-slate-900 { background-color: ${settings.color} !important; }
                    
                    /* Texto destaque */
                    #store-label span { color: ${settings.color} !important; }
                `;
                // Atualiza input de cor no admin
                document.getElementById('config-color').value = settings.color;
                document.getElementById('btn-color-preview').style.backgroundColor = settings.color;
            }
        }

        // ... (Mantendo Handlers de Login intactos) ...
        function handleLogoClick() {
            logoClicks++;
            clearTimeout(logoTimer);
            logoTimer = setTimeout(() => { logoClicks = 0; }, 2000);
            if (logoClicks === 5) { openLoginModal('admin'); logoClicks = 0; }
        }
        function handleLogoRightClick(e) {
            e.preventDefault(); masterClicks++;
            clearTimeout(masterTimer);
            masterTimer = setTimeout(() => { masterClicks = 0; }, 2000);
            if (masterClicks === 5) { openLoginModal('master'); masterClicks = 0; }
        }
        function openLoginModal(type) {
            const modal = document.getElementById('login-modal');
            const hiddenType = document.getElementById('login-type');
            modal.classList.remove('hidden');
            hiddenType.value = type;
            document.getElementById('input-pass').value = '';
            document.getElementById('input-pass').focus();

            const title = document.getElementById('login-title');
            const desc = document.getElementById('login-desc');
            const iconBg = document.getElementById('login-icon-bg');

            if (type === 'master') {
                title.innerText = "Acesso Master"; desc.innerText = "Gestão Global do Sistema";
                iconBg.classList.replace('bg-blue-100', 'bg-indigo-100');
                document.getElementById('login-icon').classList.replace('text-blue-600', 'text-indigo-600');
            } else {
                const storeName = currentStoreData ? currentStoreData.name : "Global";
                title.innerText = `Admin: ${storeName}`; desc.innerText = "Gestão da Loja";
                iconBg.classList.replace('bg-indigo-100', 'bg-blue-100');
                document.getElementById('login-icon').classList.replace('text-blue-600', 'text-blue-600');
            }
        }
        function closeLogin() { document.getElementById('login-modal').classList.add('hidden'); }
        function processLogin() {
            const type = document.getElementById('login-type').value;
            const pass = document.getElementById('input-pass').value;
            if (type === 'master') {
                if (pass === MASTER_PASS) { closeLogin(); showToast("Bem-vindo, Master!", "success"); goToMaster(); }
                else { showToast("Senha Mestra Incorreta", "error"); }
            } else {
                let validPass = DEFAULT_ADMIN_PASS;
                if (currentStoreData && currentStoreData.password) validPass = currentStoreData.password;
                if (pass === validPass) { closeLogin(); showToast("Painel da Loja Aberto", "success"); goToAdmin(); }
                else { showToast("Senha Incorreta", "error"); }
            }
        }
        document.getElementById('input-pass').addEventListener('keyup', function (e) { if (e.key === 'Enter') processLogin(); });

        // ... (Navegação) ...
        function goToVitrine() {
            document.getElementById('view-admin').classList.add('hidden-view');
            document.getElementById('view-master').classList.add('hidden-view');
            document.getElementById('view-vitrine').classList.remove('hidden-view');
            const blocked = document.getElementById('blocked-screen');
            if (blocked.classList.contains('hidden')) renderVitrine();
            window.scrollTo(0, 0);
        }
        function goToAdmin() {
            document.getElementById('view-vitrine').classList.add('hidden-view');
            document.getElementById('view-master').classList.add('hidden-view');
            document.getElementById('view-admin').classList.remove('hidden-view');
            switchMode('list');
        }
        function goToMaster() {
            document.getElementById('view-vitrine').classList.add('hidden-view');
            document.getElementById('view-admin').classList.add('hidden-view');
            document.getElementById('view-master').classList.remove('hidden-view');
            loadStoresList();
            fetchGlobalSettings(); // Carrega config ao entrar no master
        }
        function logoutAdmin() { goToVitrine(); }
        function logoutMaster() { goToVitrine(); }

        // NOVO: Função para abrir Visagismo da Vitrine - Abre modal local
        function openVisagismoFromVitrine() {
            openVisagismModal();
        }

        // --- SISTEMA DE VISAGISMO DIGITAL INTEGRADO ---
        let visagismModel = null;
        let visagismImage = null;
        let visVideoStream = null;
        let visagismData = { gender: null, type: null };

        // Inicializa o modelo MediaPipe Face Mesh para Visagismo
        async function initVisagismModel() {
            if (visagismModel) return;
            const faceMesh = new FaceMesh({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                }
            });
            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            faceMesh.onResults(onVisagismResults);
            visagismModel = faceMesh;
        }

        function openVisagismModal() {
            document.getElementById('visagism-modal').classList.remove('hidden');
            resetVisagism();

            // Carrega o modelo em background ao abrir o modal
            if (!visagismModel) {
                initVisagismModel();
            }
            lucide.createIcons();
        }

        function closeVisagismModal() {
            document.getElementById('visagism-modal').classList.add('hidden');
            stopVisagismCamera();
        }

        function resetVisagism() {
            document.getElementById('vis-step-result').classList.add('hidden');
            document.getElementById('vis-step-loading').classList.add('hidden');
            document.getElementById('vis-camera-screen').classList.add('hidden');
            document.getElementById('vis-step-q2').classList.add('hidden');

            document.getElementById('vis-step-q1').classList.remove('hidden');
            visagismData = { gender: null, type: null };
        }

        function handleVisQuestion1(gender) {
            visagismData.gender = gender;
            document.getElementById('vis-step-q1').classList.add('hidden');
            document.getElementById('vis-step-q2').classList.remove('hidden');
            lucide.createIcons();
        }

        function backToQ1() {
            document.getElementById('vis-step-q2').classList.add('hidden');
            document.getElementById('vis-step-q1').classList.remove('hidden');
        }

        function handleVisQuestion2(type) {
            visagismData.type = type;
            document.getElementById('vis-step-q2').classList.add('hidden');
            initVisagismCamera();
        }

        async function initVisagismCamera() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            const isInApp = (ua.indexOf("FBAN") > -1) || (ua.indexOf("FBAV") > -1) || (ua.indexOf("Instagram") > -1) || (ua.indexOf("WhatsApp") > -1) || (ua.indexOf("Telegram") > -1);

            if (isInApp) {
                document.getElementById('vis-native-camera-input').click();
                return;
            }

            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    // Primeiro mostra a tela da câmera
                    document.getElementById('vis-step-q1').classList.add('hidden');
                    document.getElementById('vis-step-q2').classList.add('hidden');
                    document.getElementById('vis-camera-screen').classList.remove('hidden');

                    const video = document.getElementById('vis-webcam-video');

                    // Obtém o stream da câmera
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'user',
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    });

                    video.srcObject = stream;
                    visVideoStream = stream;

                    // Aguarda o vídeo estar pronto antes de tocar
                    await new Promise((resolve, reject) => {
                        video.onloadedmetadata = () => {
                            video.play()
                                .then(() => resolve())
                                .catch(err => reject(err));
                        };
                        video.onerror = (err) => reject(err);
                        // Timeout de segurança
                        setTimeout(() => resolve(), 3000);
                    });

                    lucide.createIcons();
                } catch (err) {
                    console.warn("Câmera Visagismo não disponível, fallback nativo.", err);
                    // Fecha a tela de câmera se abriu
                    document.getElementById('vis-camera-screen').classList.add('hidden');
                    document.getElementById('vis-step-q2').classList.remove('hidden');
                    document.getElementById('vis-native-camera-input').click();
                }
            } else {
                document.getElementById('vis-native-camera-input').click();
            }
        }

        function closeVisagismCamera() {
            stopVisagismCamera();
            document.getElementById('vis-camera-screen').classList.add('hidden');
            document.getElementById('vis-step-q2').classList.remove('hidden');
        }

        function stopVisagismCamera() {
            if (visVideoStream) {
                visVideoStream.getTracks().forEach(track => track.stop());
                visVideoStream = null;
            }
        }

        function captureVisagismPhoto() {
            const video = document.getElementById('vis-webcam-video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const ctx2 = canvas.getContext('2d');
            ctx2.translate(canvas.width, 0);
            ctx2.scale(-1, 1);
            ctx2.drawImage(video, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const img = new Image();
                img.src = url;
                img.onload = () => {
                    visagismImage = img;
                    stopVisagismCamera();
                    document.getElementById('vis-camera-screen').classList.add('hidden');
                    startVisagismAnalysis();
                };
            }, 'image/jpeg');
        }

        function handleVisagismNativeUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        visagismImage = img;
                        document.getElementById('vis-step-q2').classList.add('hidden');
                        startVisagismAnalysis();
                    };
                };
                reader.readAsDataURL(file);
                input.value = '';
            }
        }

        async function startVisagismAnalysis() {
            document.getElementById('vis-step-q1').classList.add('hidden');
            document.getElementById('vis-step-q2').classList.add('hidden');
            document.getElementById('vis-step-loading').classList.remove('hidden');

            if (!visagismModel) await initVisagismModel();

            await visagismModel.send({ image: visagismImage });
        }

        function onVisagismResults(results) {
            document.getElementById('vis-step-loading').classList.add('hidden');
            document.getElementById('vis-step-result').classList.remove('hidden');

            const previewImg = document.getElementById('vis-preview-img');
            previewImg.src = visagismImage.src;

            const canvasElement = document.getElementById('vis-mesh-canvas');
            const canvasCtx = canvasElement.getContext('2d');

            canvasElement.width = visagismImage.width;
            canvasElement.height = visagismImage.height;
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];

                // Efeito Neon Verde Tecnológico
                canvasCtx.shadowColor = '#39FF14';
                canvasCtx.shadowBlur = 2;

                if (typeof drawConnectors === 'function' && typeof FACEMESH_TESSELATION !== 'undefined') {
                    drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION, { color: 'rgba(57, 255, 20, 0.15)', lineWidth: 0.5 });
                }

                canvasCtx.shadowBlur = 0;

                const analysis = analyzeFaceShapeVisagism(landmarks, visagismImage.width, visagismImage.height);
                displayVisagismResultsLocal(analysis);
            } else {
                alert("Rosto não detectado. Tente uma foto com melhor iluminação e rosto centralizado.");
                resetVisagism();
            }
            lucide.createIcons();
        }

        // Lógica Geométrica para Visagismo
        function analyzeFaceShapeVisagism(landmarks, width, height) {
            const toPixel = (landmark) => ({
                x: landmark.x * width,
                y: landmark.y * height
            });

            const cheekLeft = toPixel(landmarks[234]);
            const cheekRight = toPixel(landmarks[454]);
            const jawLeft = toPixel(landmarks[58]);
            const jawRight = toPixel(landmarks[288]);
            const templeLeft = toPixel(landmarks[103]);
            const templeRight = toPixel(landmarks[332]);
            const chin = toPixel(landmarks[152]);
            const foreheadTop = toPixel(landmarks[10]);

            const cheekWidth = Math.hypot(cheekRight.x - cheekLeft.x, cheekRight.y - cheekLeft.y);
            const jawWidth = Math.hypot(jawRight.x - jawLeft.x, jawRight.y - jawLeft.y);
            const foreheadWidth = Math.hypot(templeRight.x - templeLeft.x, templeRight.y - templeLeft.y);
            const faceHeight = Math.hypot(chin.x - foreheadTop.x, chin.y - foreheadTop.y);

            const faceIndex = faceHeight / cheekWidth;
            const jawIndex = jawWidth / cheekWidth;
            const foreheadIndex = foreheadWidth / cheekWidth;

            let shape = "Oval";
            let description = "Seu rosto tem proporções equilibradas.";
            let recommendedStyle = "quase todos os tipos de armação.";

            if (faceIndex > 1.38) {
                if (jawIndex >= 0.85) {
                    shape = "Retangular";
                    description = "Seu rosto é alongado com maxilar reto e bem definido.";
                    recommendedStyle = "armações grandes, quadradas ou aviador para equilibrar o comprimento.";
                } else if (jawIndex < 0.72 && foreheadIndex < 0.72) {
                    shape = "Diamante";
                    description = "Suas bochechas são a parte mais larga, com testa e queixo estreitos.";
                    recommendedStyle = "armações gatinho, ovais ou sem aro.";
                } else {
                    shape = "Oval";
                    description = "Seu rosto é alongado com curvas suaves e proporções harmônicas.";
                    recommendedStyle = "quase todos os estilos, especialmente geométricos e gatinho.";
                }
            } else {
                if (jawIndex >= 0.88) {
                    shape = "Quadrado";
                    description = "Seu rosto tem altura e largura similares, com maxilar marcante e angular.";
                    recommendedStyle = "armações redondas ou ovais para suavizar as linhas.";
                } else if (jawIndex >= 0.75) {
                    shape = "Redondo";
                    description = "Seu rosto tem largura e altura semelhantes, com contornos arredondados e suaves.";
                    recommendedStyle = "armações quadradas e retangulares para adicionar estrutura.";
                } else {
                    shape = "Coração";
                    description = "Sua testa é mais larga que o maxilar, e o rosto afina até o queixo.";
                    recommendedStyle = "armações ovais, redondas ou com a base mais larga (aviador).";
                }
            }

            return { shape, description, recommendedStyle };
        }

        function displayVisagismResultsLocal(analysis) {
            const textElement = document.getElementById('vis-analysis-text');
            if (textElement) {
                textElement.innerText = `${analysis.description} Para harmonizar, recomendamos ${analysis.recommendedStyle}`;
            }

            // Filtragem de Óculos com base nos produtos da loja
            const grid = document.getElementById('vis-recommendations-grid');
            grid.innerHTML = '';

            // Busca produtos da vitrine
            let allProducts = [...cachedProducts];

            // Filtra por tipo (categoria) se definido
            if (visagismData.type) {
                allProducts = allProducts.filter(item => {
                    const cat = item.category ? item.category.toLowerCase() : '';
                    return cat.includes(visagismData.type);
                });
            }

            // Se não houver itens suficientes após filtro, pega aleatórios
            if (allProducts.length === 0) {
                allProducts = [...cachedProducts].sort(() => 0.5 - Math.random()).slice(0, 3);
            } else {
                allProducts = allProducts.sort(() => 0.5 - Math.random()).slice(0, 3);
            }

            if (allProducts.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 col-span-3 text-center">Nenhum óculos encontrado para este filtro.</p>';
            }

            allProducts.forEach(item => {
                const card = document.createElement('div');
                card.className = "border border-gray-100 rounded-lg p-3 flex flex-col items-center text-center hover:shadow-md transition-all";

                // Só mostra botão de Provar se o item tiver arConfig (é customizado para AR)
                const canTryOn = item.isCustom === true && item.arConfig;

                card.innerHTML = `
                    <img src="${item.image}" class="w-full h-20 object-contain mb-2 mix-blend-multiply" onerror="this.src='https://placehold.co/200x100/f1f5f9/94a3b8?text=Sem+Imagem'">
                    <h5 class="font-bold text-xs text-gray-900 line-clamp-1">${item.name || 'Óculos'}</h5>
                    ${canTryOn ? `
                        <button onclick="closeVisagismModal(); openTryOn(${item.id})" class="mt-2 w-full bg-blue-600 text-white text-[10px] font-bold py-1.5 rounded hover:bg-blue-700 transition">
                            PROVAR
                        </button>
                    ` : `
                        <a href="${item.buyLink || '#'}" target="_blank" class="mt-2 w-full bg-green-600 text-white text-[10px] font-bold py-1.5 rounded hover:bg-green-700 transition text-center block no-underline">
                            VER DETALHES
                        </a>
                    `}
                `;
                grid.appendChild(card);
            });
            lucide.createIcons();
        }

        function showConfirm(message, onYes) {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-message').textContent = message;
            modal.classList.remove('hidden');
            const btnYes = document.getElementById('btn-confirm-yes');
            const btnNo = document.getElementById('btn-confirm-cancel');
            const newYes = btnYes.cloneNode(true);
            const newNo = btnNo.cloneNode(true);
            btnYes.parentNode.replaceChild(newYes, btnYes);
            btnNo.parentNode.replaceChild(newNo, btnNo);
            newYes.addEventListener('click', () => { modal.classList.add('hidden'); onYes(); });
            newNo.addEventListener('click', () => { modal.classList.add('hidden'); });
        }

        // =========================================================
        // === DIGITAL MODELS APP (AI GENERATION) ===
        // =========================================================
        let aiState = {
            step: 1,
            mode: null, // 'model' | 'custom'
            frameBase64: null,
            faceBase64: null,
            resultUrl: null
        };

        function openDigitalModels() {
            document.getElementById('view-digital-models').classList.remove('hidden-view');
            checkAiLimit();
            resetAiProcess();
        }

        function closeDigitalModels() {
            document.getElementById('view-digital-models').classList.add('hidden-view');
        }

        function checkAiLimit() {
            const today = new Date().toLocaleDateString();
            const lastDate = localStorage.getItem('lopix_gen_date');
            let count = parseInt(localStorage.getItem('lopix_gen_count') || '0');

            if (lastDate !== today) {
                count = 0;
                localStorage.setItem('lopix_gen_date', today);
                localStorage.setItem('lopix_gen_count', '0');
            }

            const el = document.getElementById('gen-limit-counter');
            const btn = document.getElementById('btn-generate-ai');
            const remaining = 5 - count;

            el.innerText = `${count}/5 Gerações hoje`;
            el.className = remaining <= 0 ? 'text-xs font-bold text-red-400' : 'text-xs font-bold text-slate-300';

            if (remaining <= 0) {
                btn.disabled = true;
                btn.innerText = "Limite Diário Atingido";
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            return remaining > 0;
        }

        function incrementAiCount() {
            let count = parseInt(localStorage.getItem('lopix_gen_count') || '0');
            localStorage.setItem('lopix_gen_count', (count + 1).toString());
            checkAiLimit();
        }

        function goToAiStep(step) {
            document.querySelectorAll('.ai-step').forEach(el => el.classList.remove('active'));
            document.getElementById(`ai-step-${step}`).classList.add('active');
            aiState.step = step;
            lucide.createIcons();
        }

        function handleAiFrameUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                aiState.frameBase64 = e.target.result.split(',')[1]; // Store raw base64
                const preview = document.getElementById('ai-frame-preview');
                preview.src = e.target.result;
                preview.classList.remove('hidden');
                document.getElementById('ai-frame-placeholder').classList.add('hidden');
                document.getElementById('btn-ai-next-1').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        function selectAiMode(mode) {
            aiState.mode = mode;
            goToAiStep(3);

            const title = document.getElementById('step-3-title');
            const icon = document.getElementById('step-3-icon');
            const customArea = document.getElementById('ai-custom-upload-area');
            const modelDescGroup = document.getElementById('ai-model-desc-group');
            const btn = document.getElementById('btn-generate-ai');

            if (mode === 'custom') {
                title.innerText = "Sua Foto e Cenário";
                icon.setAttribute('data-lucide', 'camera');
                customArea.classList.remove('hidden');
                modelDescGroup.classList.add('hidden');
                btn.disabled = true; // Wait for upload
            } else {
                title.innerText = "Personalizar Modelo";
                icon.setAttribute('data-lucide', 'bot');
                customArea.classList.add('hidden');
                modelDescGroup.classList.remove('hidden');
                btn.disabled = false;
                checkAiLimit(); // Re-check limit
            }
            lucide.createIcons();
        }

        function handleAiFaceUpload(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                aiState.faceBase64 = e.target.result.split(',')[1];
                const preview = document.getElementById('ai-face-preview');
                preview.src = e.target.result;
                preview.classList.remove('hidden');
                document.getElementById('ai-face-icon').classList.add('hidden');

                if (checkAiLimit()) {
                    document.getElementById('btn-generate-ai').disabled = false;
                }
            };
            reader.readAsDataURL(file);
        }

        function toggleAiSceneInput() {
            const checked = document.getElementById('ai-keep-bg').checked;
            const input = document.getElementById('ai-prompt-scene');
            input.disabled = checked;
            if (checked) {
                input.classList.add('opacity-50');
                input.value = '';
            } else {
                input.classList.remove('opacity-50');
            }
        }

        function resetAiProcess() {
            aiState = { step: 1, mode: null, frameBase64: null, faceBase64: null, resultUrl: null };
            goToAiStep(1);

            // Clear inputs
            document.querySelectorAll('#view-digital-models input').forEach(i => i.value = '');
            document.querySelectorAll('#view-digital-models img').forEach(i => {
                if (i.id !== 'ai-result-image') i.classList.add('hidden');
            });
            document.getElementById('ai-result-image').src = '';
            document.getElementById('ai-frame-placeholder').classList.remove('hidden');
            document.getElementById('ai-face-icon').classList.remove('hidden');
            document.getElementById('btn-ai-next-1').disabled = true;
            document.getElementById('ai-keep-bg').checked = false;
            document.getElementById('ai-prompt-scene').disabled = false;
            document.getElementById('ai-prompt-scene').classList.remove('opacity-50');

            checkAiLimit();
        }

        async function generateAIImage() {
            if (!checkAiLimit()) return;
            if (!apiKey) { showToast("Erro: Chave API da IA não configurada. Contate o suporte.", "error"); return; }

            const keepBg = document.getElementById('ai-keep-bg').checked;
            const scenePrompt = document.getElementById('ai-prompt-scene').value;
            const modelPrompt = document.getElementById('ai-prompt-model').value;

            // Build Prompt
            let finalPrompt = "";
            let imageParts = [];

            // Add Frame Image (Always present)
            imageParts.push({
                inlineData: { mimeType: "image/png", data: aiState.frameBase64 }
            });

            if (aiState.mode === 'custom') {
                if (!aiState.faceBase64) { showToast("Faça upload da sua foto", "error"); return; }

                // Add Face Image
                imageParts.push({
                    inlineData: { mimeType: "image/jpeg", data: aiState.faceBase64 }
                });

                finalPrompt = "Here are two images: one of a person and one of a pair of glasses. Synthesize a realistic image of the person wearing these specific glasses. Maintain facial identity, hair, skin tone, and features exactly. Ensure the glasses fit naturally on the face with correct perspective and shadows.";

                if (keepBg) {
                    finalPrompt += " Do NOT change the background. Keep the original background exactly as is.";
                } else if (scenePrompt) {
                    finalPrompt += ` Change the background to: ${scenePrompt}. Ensure lighting matches the new scene.`;
                }

            } else {
                // AI Model Mode
                const description = modelPrompt || "a professional model";
                const scene = scenePrompt || "studio lighting";

                finalPrompt = `Generate a hyper-realistic image of ${description} wearing the glasses shown in the first image. The glasses must look exactly like the input image. The setting is: ${scene}. Professional photography, 8k resolution, highly detailed texture.`;
            }

            // API Call
            document.getElementById('ai-loading').classList.remove('hidden');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: finalPrompt },
                                ...imageParts
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(response.status === 400 ? 'Chave API inválida ou Payload incorreto' : 'Erro na geração');
                }

                const data = await response.json();

                // Extract Image
                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
                    const imgPart = data.candidates[0].content.parts.find(p => p.inlineData);
                    if (imgPart) {
                        const base64Img = imgPart.inlineData.data;
                        const mimeType = imgPart.inlineData.mimeType || "image/png";
                        aiState.resultUrl = `data:${mimeType};base64,${base64Img}`;

                        document.getElementById('ai-result-image').src = aiState.resultUrl;
                        incrementAiCount();
                        goToAiStep('result');
                    } else {
                        // Safety block or text only
                        throw new Error("A IA não retornou uma imagem. Tente modificar o prompt.");
                    }
                } else {
                    throw new Error("Erro desconhecido na resposta da API");
                }

            } catch (error) {
                console.error(error);
                showToast(error.message, 'error');
                // Optional: Show modal specific for API Key error if needed
                if (error.message.includes('Chave API')) {
                    alert("Erro de Configuração: API Key do Gemini não encontrada ou inválida. Verifique o código.");
                }
            } finally {
                document.getElementById('ai-loading').classList.add('hidden');
            }
        }

        function downloadAiImage() {
            if (!aiState.resultUrl) return;
            const a = document.createElement('a');
            a.href = aiState.resultUrl;
            a.download = `lopix-model-${Date.now()}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }


        // ... (Lógica Painel Master - CRUD Lojas) ...

        // Toggle para campo de limite de IA
        function toggleAiLimitField() {
            const aiCheckbox = document.getElementById('store-allow-ai');
            const limitField = document.getElementById('ai-limit-field');
            if (aiCheckbox && limitField) {
                if (aiCheckbox.checked) {
                    limitField.classList.remove('hidden');
                } else {
                    limitField.classList.add('hidden');
                }
            }
        }

        async function saveStore() {
            try {
                const idEl = document.getElementById('store-id-hidden');
                const nameEl = document.getElementById('store-name');
                const passEl = document.getElementById('store-pass');
                const planEl = document.getElementById('store-plan');
                const statusEl = document.getElementById('store-status');
                const allowAiEl = document.getElementById('store-allow-ai');
                const allowCameraEl = document.getElementById('store-allow-camera');
                const allowImageEl = document.getElementById('store-allow-image');
                const allowVisagismoEl = document.getElementById('store-allow-visagismo');
                const allowDnpEl = document.getElementById('store-allow-dnp');
                const aiDailyLimitEl = document.getElementById('store-ai-daily-limit');
                const apiSourceRadio = document.querySelector('input[name="store-api-source"]:checked');

                if (!idEl || !nameEl || !passEl || !planEl || !statusEl) {
                    console.error("Elementos do formulário não encontrados");
                    return;
                }

                const id = idEl.value;
                const name = nameEl.value;
                const pass = passEl.value;
                const plan = planEl.value;
                const status = statusEl.value;
                const allowAi = allowAiEl ? allowAiEl.checked : false;
                const allowCamera = allowCameraEl ? allowCameraEl.checked : false;
                const allowImage = allowImageEl ? allowImageEl.checked : false;
                const allowVisagismo = allowVisagismoEl ? allowVisagismoEl.checked : false;
                const allowDnp = allowDnpEl ? allowDnpEl.checked : false;
                const aiDailyLimit = aiDailyLimitEl ? parseInt(aiDailyLimitEl.value) || 5 : 5;
                const useMasterApi = apiSourceRadio ? apiSourceRadio.value === 'master' : true;

                if (!name || !pass) {
                    showToast("Preencha nome e senha", "error");
                    return;
                }

                let expiresAt = 'unlimited';
                const now = Date.now();
                const day = 24 * 60 * 60 * 1000;

                if (plan === '7_days') expiresAt = now + (7 * day);
                if (plan === '1_month') expiresAt = now + (30 * day);
                if (plan === '12_months') expiresAt = now + (365 * day);

                // Determina o tipo de provador e gera link apropriado
                let provadorType = 'none';
                if (allowCamera) provadorType = 'camera';
                if (allowImage) provadorType = 'image';

                const storeData = {
                    name: name,
                    password: pass,
                    expiresAt: expiresAt,
                    active: status === 'active',
                    allowAi: allowAi,
                    allowCamera: allowCamera,
                    allowImage: allowImage,
                    allowVisagismo: allowVisagismo,
                    allowDnp: allowDnp,
                    provadorType: provadorType,
                    aiDailyLimit: aiDailyLimit,
                    useMasterApi: useMasterApi
                };

                if (id) {
                    // Update
                    await db.collection('stores').doc(id).update(storeData);
                    showToast("Loja atualizada!", "success");
                } else {
                    // Create
                    storeData.createdAt = now;
                    storeData.aiGenerationsCount = 0;
                    await db.collection('stores').add(storeData);
                    showToast("Loja criada!", "success");
                }

                // Fecha o form e recarrega a lista
                toggleMasterForm(false);
                loadStoresList();
            } catch (e) {
                console.error("Erro ao salvar loja:", e);
                showToast("Erro ao salvar: " + e.message, "error");
            }
        }

        function editStore(id, name, pass, statusStr, allowAi, allowCamera, allowImage, allowVisagismo, allowDnp) {
            toggleMasterForm(true); // Abre o form

            document.getElementById('store-id-hidden').value = id;
            document.getElementById('store-name').value = name;
            document.getElementById('store-pass').value = pass;
            document.getElementById('store-status').value = statusStr;
            document.getElementById('store-allow-ai').checked = (allowAi === 'true' || allowAi === true);
            document.getElementById('store-allow-camera').checked = (allowCamera === 'true' || allowCamera === true || allowCamera === undefined);
            document.getElementById('store-allow-image').checked = (allowImage === 'true' || allowImage === true);
            document.getElementById('store-allow-visagismo').checked = (allowVisagismo === 'true' || allowVisagismo === true);
            document.getElementById('store-allow-dnp').checked = (allowDnp === 'true' || allowDnp === true);

            document.getElementById('master-form-title').innerHTML = `<i data-lucide="edit" class="w-5 h-5 text-indigo-600"></i> Editar Ótica`;
            document.getElementById('btn-save-store').innerText = "Salvar Alterações";
            lucide.createIcons();
        }

        function resetMasterForm() {
            document.getElementById('store-id-hidden').value = '';
            document.getElementById('store-name').value = '';
            document.getElementById('store-pass').value = '';
            document.getElementById('store-status').value = 'active';
            document.getElementById('store-allow-ai').checked = false;
            document.getElementById('store-allow-camera').checked = true; // Padrão: Câmera ativa
            document.getElementById('store-allow-image').checked = false;
            document.getElementById('store-allow-visagismo').checked = false;
            document.getElementById('store-allow-dnp').checked = false;

            document.getElementById('master-form-title').innerHTML = `<i data-lucide="plus-circle" class="w-5 h-5 text-indigo-600"></i> Nova Ótica`;
            document.getElementById('btn-save-store').innerText = "Criar Acesso";
            lucide.createIcons();
        }

        function resetMasterForm() {
            document.getElementById('store-id-hidden').value = '';
            document.getElementById('store-name').value = '';
            document.getElementById('store-pass').value = '';
            document.getElementById('store-status').value = 'active';
            document.getElementById('store-allow-ai').checked = false;
            document.getElementById('store-allow-camera').checked = true; // Padrão: Câmera ativa
            document.getElementById('store-allow-image').checked = false;

            document.getElementById('master-form-title').innerHTML = `<i data-lucide="plus-circle" class="w-5 h-5 text-indigo-600"></i> Nova Ótica`;
            document.getElementById('btn-save-store').innerText = "Criar Acesso";
            lucide.createIcons();
        }

        // NOVO: Função de exclusão mútua entre provadores
        function handleProvadorToggle(type) {
            const cameraEl = document.getElementById('store-allow-camera');
            const imageEl = document.getElementById('store-allow-image');

            if (type === 'camera' && cameraEl.checked) {
                imageEl.checked = false;
            } else if (type === 'image' && imageEl.checked) {
                cameraEl.checked = false;
            }
        }

        async function loadStoresList() {
            const listEl = document.getElementById('stores-list');
            listEl.innerHTML = '<div class="loader mx-auto"></div>';

            try {
                const snap = await db.collection('stores').orderBy('createdAt', 'desc').get();
                listEl.innerHTML = '';

                if (snap.empty) {
                    listEl.innerHTML = '<p class="text-slate-500 text-center">Nenhuma loja cadastrada.</p>';
                    return;
                }

                snap.forEach(doc => {
                    const store = doc.data();
                    const id = doc.id;

                    let expiryLabel = "Ilimitado";
                    let statusClass = "text-green-600 bg-green-100";
                    let statusText = "Ativo";

                    if (store.expiresAt !== 'unlimited') {
                        const date = new Date(store.expiresAt);
                        expiryLabel = date.toLocaleDateString();
                        if (Date.now() > store.expiresAt) {
                            statusClass = "text-red-600 bg-red-100";
                            statusText = "Expirado";
                        }
                    }

                    if (!store.active) {
                        statusClass = "text-gray-600 bg-gray-200";
                        statusText = "Desativado";
                    }

                    const statusVal = store.active !== false ? 'active' : 'inactive';

                    // Geração do Link baseado no tipo de provador selecionado
                    let rawLink = '';
                    if (store.allowImage) {
                        // Link para Provador por Imagem
                        rawLink = `${window.location.origin}/provador-imagem.html?store=${encodeURIComponent(store.name)}`;
                    } else {
                        // Link para Provador por Câmera (ou vitrine padrão)
                        rawLink = `${window.location.origin}${window.location.pathname}?store=${encodeURIComponent(store.name)}`;
                    }
                    // Escapa aspas simples para não quebrar o HTML do onclick
                    const safeLink = rawLink.replace(/'/g, "\\'");

                    // Determinar qual provador está ativo
                    const provadorLabel = store.allowImage ? 'Provador: Imagem' : (store.allowCamera !== false ? 'Provador: Câmera' : 'Provador: Desativado');

                    // Labels das funcionalidades extras
                    const funcionalidades = [];
                    if (store.allowVisagismo) funcionalidades.push('Visagismo');
                    if (store.allowDnp) funcionalidades.push('DNP');
                    if (store.allowAi) funcionalidades.push('IA');
                    const funcLabel = funcionalidades.length > 0 ? funcionalidades.join(' • ') : 'Nenhuma';

                    // Métricas (óculos e gerações IA)
                    const oculosCount = store.items?.length || 0;
                    const aiGenCount = store.aiGenerationsCount || 0;
                    const aiLimit = store.aiDailyLimit || 5;

                    const item = document.createElement('div');
                    item.className = "bg-white p-4 rounded-lg border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4";
                    item.innerHTML = `
                        <div class="flex-1 w-full">
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="font-bold text-slate-800 text-lg">${store.name}</h3>
                                <span class="text-xs px-2 py-1 rounded-full font-bold ${statusClass}">${statusText}</span>
                            </div>
                            <p class="text-xs text-slate-500 mb-2">Expira em: ${expiryLabel} • Senha: <b>${store.password}</b></p>
                            <p class="text-[10px] text-slate-400 mb-2 font-mono">${provadorLabel} • Extras: ${funcLabel}</p>
                            
                            <!-- Métricas -->
                            <div class="flex gap-4 mb-2">
                                <div class="flex items-center gap-1 text-xs text-slate-600 bg-blue-50 px-2 py-1 rounded">
                                    <i data-lucide="glasses" class="w-3 h-3 text-blue-500"></i>
                                    <span><b>${oculosCount}</b> óculos</span>
                                </div>
                                ${store.allowAi ? `<div class="flex items-center gap-1 text-xs text-slate-600 bg-purple-50 px-2 py-1 rounded">
                                    <i data-lucide="sparkles" class="w-3 h-3 text-purple-500"></i>
                                    <span><b>${aiGenCount}</b> gerações (${aiLimit}/dia)</span>
                                </div>` : ''}
                            </div>
                            
                            <div class="flex items-center gap-2 bg-slate-50 p-2 rounded border border-slate-200 mt-2">
                                <i data-lucide="link" class="w-4 h-4 text-slate-400"></i>
                                <input type="text" readonly value="${rawLink}" class="bg-transparent text-xs text-blue-600 w-full outline-none select-all" onclick="this.select()">
                                <button onclick="navigator.clipboard.writeText('${safeLink}'); showToast('Copiado!', 'info')" class="text-xs font-bold text-slate-600 hover:text-black">Copiar</button>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editStore('${id}', '${store.name}', '${store.password}', '${statusVal}', '${store.allowAi}', '${store.allowCamera !== false}', '${store.allowImage === true}', '${store.allowVisagismo === true}', '${store.allowDnp === true}')" class="text-blue-500 hover:bg-blue-50 p-2 rounded transition" title="Editar">
                                <i data-lucide="edit-2" class="w-5 h-5"></i>
                            </button>
                            <button onclick="deleteStore('${id}')" class="text-red-500 hover:bg-red-50 p-2 rounded transition" title="Excluir Loja">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>`;
                    listEl.appendChild(item);
                });
                lucide.createIcons();
            } catch (e) { console.error(e); }
        }

        async function deleteStore(id) {
            showConfirm("Tem certeza que deseja excluir esta loja e perder o acesso a ela?", async () => {
                try { await db.collection('stores').doc(id).delete(); showToast("Loja removida.", "success"); loadStoresList(); }
                catch (e) { showToast("Erro ao excluir", "error"); }
            });
        }

        // ... (Categorias) ...
        function formatPriceInput(input) {
            let v = input.value.replace(/\D/g, ''); v = (v / 100).toFixed(2) + ''; v = v.replace(".", ","); v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1."); input.value = v;
        }
        let categories = ['Masculino', 'Feminino', 'Infantil', 'Unissex'];
        async function initCategories() {
            try {
                const doc = await db.collection('settings').doc('categories').get();
                if (doc.exists) { categories = doc.data().list || categories; }
                else { await db.collection('settings').doc('categories').set({ list: categories }); }
            } catch (e) { }
            renderCategorySelect();
            renderCategoryManager();
            renderVitrineFilters(); // NOVO: Inicia filtros na vitrine
        }
        function renderCategorySelect() {
            const sel = document.getElementById('prod-category'); const currentVal = sel.value; sel.innerHTML = '';
            categories.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.innerText = c; sel.appendChild(opt); });
            if (categories.includes(currentVal)) sel.value = currentVal;
        }
        function renderCategoryManager() {
            const container = document.getElementById('cat-list-display'); container.innerHTML = '';
            categories.forEach((c, idx) => {
                const tag = document.createElement('span'); tag.className = 'bg-white border border-gray-200 text-xs px-2 py-1 rounded flex items-center gap-1';
                tag.innerHTML = `${c} <button onclick="removeCategory(${idx})" class="text-red-500 hover:text-red-700 ml-1 font-bold">×</button>`; container.appendChild(tag);
            });
        }
        function toggleCatManager() { document.getElementById('cat-manager').classList.toggle('hidden'); }
        function addNewCategory() {
            const input = document.getElementById('new-cat-input'); const val = input.value.trim();
            if (val && !categories.includes(val)) { categories.push(val); saveCategories(); input.value = ''; }
        }
        function removeCategory(index) {
            if (categories.length <= 1) { showToast("É necessário ter pelo menos uma categoria.", "error"); return; }
            showConfirm(`Excluir categoria "${categories[index]}"?`, () => { categories.splice(index, 1); saveCategories(); });
        }
        function saveCategories() {
            db.collection('settings').doc('categories').set({ list: categories }).then(() => {
                renderCategorySelect();
                renderCategoryManager();
                renderVitrineFilters(); // Atualiza filtros também
            });
        }
        initCategories();

        // --- GESTÃO AUTOMÁTICA DE LINK WHATSAPP ---
        function toggleWhatsAppConfig() {
            const isChecked = document.getElementById('wa-auto-generate').checked;
            const container = document.getElementById('wa-config-container');

            if (isChecked) {
                container.classList.remove('hidden');
                // Carregar configs salvas se os campos estiverem vazios
                if (!document.getElementById('wa-number').value) {
                    loadWhatsAppConfig();
                }
                updateWhatsAppLink();
            } else {
                container.classList.add('hidden');
            }
            // Salvar estado do checkbox
            safeStorage.setItem('wa_auto_enabled', isChecked);
        }

        function loadWhatsAppConfig() {
            const savedNumber = safeStorage.getItem('wa_number');
            const savedMessage = safeStorage.getItem('wa_message');
            const savedEnabled = safeStorage.getItem('wa_auto_enabled') === 'true';

            if (savedNumber) document.getElementById('wa-number').value = savedNumber;
            if (savedMessage) document.getElementById('wa-message').value = savedMessage;

            document.getElementById('wa-auto-generate').checked = savedEnabled;
            if (savedEnabled) {
                document.getElementById('wa-config-container').classList.remove('hidden');
            }
        }

        // Função acionada ao alterar número ou mensagem
        function handleWaParamChange() {
            // Apenas exibe o botão para atualizar, não altera link automaticamente
            document.getElementById('btn-update-wa').classList.remove('hidden');
        }

        // Função do botão "Atualizar link"
        function applyWaParams() {
            const number = document.getElementById('wa-number').value.trim();
            const message = document.getElementById('wa-message').value.trim();

            // Salvar novas configurações
            safeStorage.setItem('wa_number', number);
            safeStorage.setItem('wa_message', message);

            // Forçar atualização do link
            updateWhatsAppLink(true);

            // Esconder botão
            document.getElementById('btn-update-wa').classList.add('hidden');
            showToast("Link atualizado e configurações salvas!", "success");
        }

        // Função para gerar o link (acionada pelo nome ou pelo botão de atualizar)
        function updateWhatsAppLink(force = false) {
            const isEnabled = document.getElementById('wa-auto-generate').checked;
            if (!isEnabled && !force) return;

            const number = document.getElementById('wa-number').value.trim();
            const message = document.getElementById('wa-message').value.trim();
            const prodName = document.getElementById('prod-name').value.trim();

            if (number) {
                // Inclui o nome do óculos na mensagem
                const fullMessage = prodName ? `${message} ${prodName}`.trim() : message;
                const encodedMessage = encodeURIComponent(fullMessage);
                const finalLink = `https://api.whatsapp.com/send/?phone=${number}&text=${encodedMessage}`;
                document.getElementById('prod-link').value = finalLink;
            }
        }

        // --- VITRINE LÓGICA (Via Firebase) ---
        let cachedProducts = [];
        const defaultProducts = [

        ];

        // NOVO: Renderiza os filtros da vitrine
        function renderVitrineFilters() {
            const container = document.getElementById('vitrine-category-filters');
            if (!container) return;
            container.innerHTML = '';

            const allCats = ['Todos', ...categories];

            allCats.forEach(cat => {
                const btn = document.createElement('button');

                // Lógica de seleção
                const isSelected = (cat === 'Todos' && currentVitrineCategory === 'all') || (cat === currentVitrineCategory);

                // Estilos
                const baseClass = "px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 whitespace-nowrap flex-shrink-0";
                const activeClass = "bg-slate-900 text-white shadow-md transform scale-105";
                const inactiveClass = "bg-white text-slate-600 border border-slate-200 hover:border-slate-300 hover:bg-slate-50";

                btn.className = `${baseClass} ${isSelected ? activeClass : inactiveClass}`;
                btn.innerText = cat;

                btn.onclick = () => {
                    currentVitrineCategory = cat === 'Todos' ? 'all' : cat;
                    renderVitrineFilters(); // Re-render botões para atualizar estado visual
                    updateVitrineGrid(); // Filtra localmente sem fetch
                };

                container.appendChild(btn);
            });
        }

        async function renderVitrine() {
            // Carrega dados iniciais
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '<div class="col-span-full flex justify-center py-8"><div class="loader"></div></div>';

            let publishedItems = [];
            try {
                const snapshot = await db.collection('products').orderBy('createdAt', 'desc').get();
                publishedItems = snapshot.docs.map(doc => ({ _firestoreId: doc.id, ...doc.data() }));
            } catch (e) { console.error(e); }

            let finalProducts = [];
            if (CURRENT_STORE_ID) { finalProducts = publishedItems.filter(p => p.storeId === CURRENT_STORE_ID); }
            else { finalProducts = publishedItems.filter(p => !p.storeId); finalProducts = [...finalProducts, ...defaultProducts]; }

            cachedProducts = finalProducts;

            // Chama a renderização do grid (que agora suporta filtro local)
            updateVitrineGrid();
        }

        // NOVO: Função separada para atualizar o grid (permite filtro sem fetch)
        function updateVitrineGrid() {
            const grid = document.getElementById('product-grid');
            if (!grid) return;

            let filteredProducts = cachedProducts;

            // Aplica filtro de categoria
            if (currentVitrineCategory !== 'all') {
                filteredProducts = filteredProducts.filter(p => p.category === currentVitrineCategory);
            }

            // Remove duplicatas
            const uniqueProducts = Array.from(new Map(filteredProducts.map(item => [item.id, item])).values());

            grid.innerHTML = '';
            if (uniqueProducts.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-12 flex flex-col items-center"><i data-lucide="package-open" class="w-12 h-12 text-gray-300 mb-2"></i><p>Nenhum modelo encontrado nesta categoria.</p></div>';
                lucide.createIcons();
                return;
            }

            uniqueProducts.forEach(product => {
                if (product.active === false) return;
                const card = document.createElement('div'); card.className = "bg-white rounded-xl overflow-hidden glass-card flex flex-col";

                // Formatação Preço
                let priceDisplay = 'Consultar preço';
                if (product.price && parseFloat(product.price.replace(',', '.')) > 0) {
                    let displayPrice = product.price;
                    if (!displayPrice.includes(',')) displayPrice = parseFloat(displayPrice || 0).toFixed(2).replace('.', ',');
                    priceDisplay = `R$ ${displayPrice}`;
                }

                const isCustom = product.isCustom === true;
                const buyLink = product.buyLink || `https://wa.me/5511999999999?text=Quero%20o%20${encodeURIComponent(product.name)}`;

                // NOVO: Determinar qual provador exibir baseado nas configurações da loja
                const allowCamera = currentStoreData ? (currentStoreData.allowCamera !== false) : true;
                const allowImage = currentStoreData ? (currentStoreData.allowImage === true) : false;

                let provadorButton = '';
                if (allowImage) {
                    // Provador por Imagem - Abre em nova aba
                    const imageProvadorUrl = `${window.location.origin}/provador-imagem.html?store=${encodeURIComponent(currentStoreData?.name || 'default')}&product=${encodeURIComponent(product.name)}&image=${encodeURIComponent(product.image)}`;
                    provadorButton = `<a href="${imageProvadorUrl}" target="_blank" class="w-full bg-black text-white text-sm font-bold py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-800 transition shadow-sm no-underline"><i class="fa-solid fa-image"></i> Provar com Foto</a>`;
                } else if (allowCamera && isCustom) {
                    // Provador por Câmera (AR)
                    provadorButton = `<button onclick="openTryOn(${product.id})" class="w-full bg-black text-white text-sm font-bold py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-800 transition shadow-sm"><i class="fa-solid fa-glasses"></i> Provador</button>`;
                } else if (allowCamera && !isCustom) {
                    // Câmera ativa mas produto não customizado
                    provadorButton = `<button onclick="showToast('Provador disponível apenas para modelos configurados no Admin.', 'info')" class="w-full bg-black text-white text-sm font-bold py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-800 transition shadow-sm"><i class="fa-solid fa-glasses"></i> Provador</button>`;
                } else {
                    // Nenhum provador ativo - botão desativado
                    provadorButton = `<button disabled class="w-full bg-gray-300 text-gray-500 text-sm font-bold py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 cursor-not-allowed shadow-sm"><i class="fa-solid fa-glasses"></i> Provador Indisponível</button>`;
                }

                // ERROR HANDLER UPDATE: Adicionado Fallback para Imagem e classe P-8 para manter grid alinhado
                const fallbackImage = "https://placehold.co/400x400/f1f5f9/94a3b8?text=Sem+Imagem";

                card.innerHTML = `
                    <div class="aspect-square w-full bg-gray-100 flex items-center justify-center p-4 relative group">
                        <img src="${product.image}" class="max-h-full max-w-full object-contain mix-blend-multiply transition-transform group-hover:scale-105" onerror="this.src='${fallbackImage}'; this.classList.add('p-8');">
                        ${isCustom ? '<span class="absolute top-2 right-2 bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded font-bold"></span>' : ''}
                        <span class="absolute top-2 left-2 bg-gray-200 text-gray-700 text-[10px] px-2 py-1 rounded font-medium uppercase tracking-wide">${product.category || 'Geral'}</span>
                    </div>
                    <div class="p-4 flex flex-col gap-3 flex-grow">
                        <div><h4 class="font-bold text-gray-800 text-base leading-tight">${product.name}</h4><p class="text-gray-500 text-sm font-medium mt-1">${priceDisplay}</p></div>
                        <div class="mt-auto flex flex-col gap-2">
                            ${provadorButton}
                            <a href="${buyLink}" target="_blank" class="w-full bg-green-50 text-green-700 border border-green-200 text-sm font-bold py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 hover:bg-green-100 transition text-center no-underline shadow-sm"><i class="fa-brands fa-whatsapp"></i> Comprar</a>
                        </div>
                    </div>`;
                grid.appendChild(card);
            });
            lucide.createIcons(); // Re-render icons for new elements
        }

        // --- PROVADOR LÓGICA ATUALIZADA ---

        // 1. Manipulação do Botão Voltar (History API)
        window.addEventListener('popstate', (event) => {
            const overlay = document.getElementById('tryon-overlay');
            if (!overlay.classList.contains('hidden')) {
                // Se o overlay estiver aberto e o usuário voltar, fecha sem navegar pra trás de novo
                closeTryOn(false);
            }
        });

        function openTryOn(id) {
            const item = cachedProducts.find(i => i.id === id);
            if (!item || !item.arConfig) { showToast("Erro: Configuração AR não encontrada.", "error"); return; }

            // Push State para interceptar o botão voltar do navegador
            window.history.pushState({ view: 'tryon' }, 'Provador', '#provador');

            const overlay = document.getElementById('tryon-overlay');
            overlay.classList.remove('hidden');

            // NEW LOGIC FOR PRICE
            let priceText = 'Consultar preço';
            if (item.price && parseFloat(item.price.replace(',', '.')) > 0) {
                let displayPrice = item.price;
                if (!displayPrice.includes(',')) displayPrice = parseFloat(displayPrice || 0).toFixed(2).replace('.', ',');
                priceText = `R$ ${displayPrice}`;
            }

            // Update the label with Name + Price
            document.getElementById('tryon-product-name').innerText = `${item.name} • ${priceText}`;

            // ATUALIZAÇÃO DO BOTÃO COMPRAR NA TELA DA CÂMERA
            const buyBtn = document.getElementById('tryon-buy-btn');
            if (buyBtn) {
                // Usa o link do produto ou gera um link padrão do WhatsApp igual ao da vitrine
                const defaultLink = `https://api.whatsapp.com/send/?phone=5511999999999&text=Quero%20o%20${encodeURIComponent(item.name)}`;
                buyBtn.href = item.buyLink || defaultLink;
            }

            const canvasWrapper = document.getElementById('canvas-wrapper');
            const targetContainer = document.getElementById('tryon-video-container');
            if (!canvasWrapper || !targetContainer) return;

            canvasWrapper.classList.add('tryon-mode');
            targetContainer.appendChild(canvasWrapper);

            const v = document.getElementById('video');
            if (v && !v.paused) v.play().catch(e => { });

            if (!state.videoStarted) init();

            applyGlassesConfig(item.arConfig);
            // Galeria removida, não chamamos mais renderTryOnGallery

            // Scroll suave para garantir foco (embora seja fixed, ajuda em alguns mobile browsers que escondem barra de endereço)
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Função de Fechar atualizada para aceitar navegação
        function closeTryOn(navigateBack = false) {
            // Se foi clicado no botão (navigateBack = true), voltamos no histórico
            // Isso acionará o 'popstate', que fechará o overlay se não tratarmos aqui.
            // Mas para ser imediato e evitar loops, podemos gerenciar manualmente.

            if (navigateBack) {
                window.history.back();
                // O evento popstate vai chamar closeTryOn(false)
                return;
            }

            const overlay = document.getElementById('tryon-overlay');
            overlay.classList.add('hidden');

            const canvasWrapper = document.getElementById('canvas-wrapper');
            const originalContainer = document.getElementById('admin-ar-container');

            if (canvasWrapper && originalContainer) {
                canvasWrapper.classList.remove('tryon-mode');
                originalContainer.prepend(canvasWrapper);
                const v = document.getElementById('video');
                if (v) v.play().catch(e => { });
            }

            // Scroll suave de volta para a vitrine (contexto é mantido pelo browser no back(), mas forçamos se precisar)
            // Como usamos history.back(), o browser deve restaurar a posição.
        }

        function applyGlassesConfig(config) {
            showToast("Trocando modelo...", "info"); document.getElementById('loading-overlay').classList.remove('hidden');
            state.model.parts.front.x = config.frontParams.x; state.model.parts.front.y = config.frontParams.y; state.model.parts.front.scale = config.frontParams.scale;
            if (config.leftParams) Object.assign(state.model.parts.left, config.leftParams);
            if (config.rightParams) Object.assign(state.model.parts.right, config.rightParams);
            state.autoAnchors = config.autoAnchors;
            const loadImage = (url) => { return new Promise((resolve) => { if (!url) return resolve(null); const img = new Image(); img.crossOrigin = "Anonymous"; img.onload = () => resolve(img); img.onerror = () => resolve(null); img.src = url; }); };
            Promise.all([loadImage(config.front), loadImage(config.left), loadImage(config.right)]).then(([imgFront, imgLeft, imgRight]) => {
                if (imgFront) { state.model.parts.front.img = imgFront; state.model.parts.front.remoteUrl = config.front; document.getElementById('thumb-front').src = config.front; }
                if (imgLeft) { state.model.parts.left.img = imgLeft; state.model.parts.left.remoteUrl = config.left; document.getElementById('thumb-left').src = config.left; }
                if (imgRight) { state.model.parts.right.img = imgRight; state.model.parts.right.remoteUrl = config.right; document.getElementById('thumb-right').src = config.right; }
                if (state.videoStarted) { document.getElementById('loading-overlay').classList.add('hidden'); }
            });
        }

        // =========================================================
        // === ADMIN CORE ===
        // =========================================================

        const safeStorage = { getItem: (key) => localStorage.getItem(key), setItem: (key, val) => localStorage.setItem(key, val), removeItem: (key) => localStorage.removeItem(key) };
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = `toast toast-${type}`;
            let icon = type === 'success' ? '<i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>' : (type === 'error' ? '<i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i>' : '<i data-lucide="info" class="w-5 h-5 mr-2"></i>');
            toast.innerHTML = `${icon}<span>${message}</span>`; container.appendChild(toast); lucide.createIcons();
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateX(100%)'; setTimeout(() => toast.remove(), 300); }, 3000);
        }
        const IMGBB_API_KEY = "47bfb1180acb019f8141a9d1d0aa4502";
        const state = {
            mode: 'editor', editingPart: null, dragTarget: null, hoverTarget: null, zoom: 1.0, autoAnchors: true, showTemples: false, editingId: null,
            model: { parts: { front: { img: null, remoteUrl: null, x: 0, y: 0, scale: 1.0 }, left: { img: null, remoteUrl: null, scale: 1.0, x: 0, y: 0, anchorFrame: { x: -0.35, y: -0.05 }, anchorEar: { x: 0, y: 0 } }, right: { img: null, remoteUrl: null, scale: 1.0, x: 0, y: 0, anchorFrame: { x: 0.35, y: -0.05 }, anchorEar: { x: 0, y: 0 } } } },
            videoStarted: false, faceMesh: null, smoothed: { x: null, y: null, w: 100, angle: 0, yaw: 0, jawLeft: { x: 0, y: 0 }, jawRight: { x: 0, y: 0 } },
            history: [], historyIndex: -1 // Undo System
        };
        const video = document.getElementById('video'); const canvas = document.getElementById('output-canvas'); const ctx = canvas.getContext('2d'); const canvasWrapper = document.getElementById('canvas-wrapper');

        // --- UNDO SYSTEM ---
        function pushHistory() {
            // Snapshot current state
            const snapshot = JSON.stringify({
                parts: {
                    front: { ...state.model.parts.front, img: undefined },
                    left: { ...state.model.parts.left, img: undefined },
                    right: { ...state.model.parts.right, img: undefined }
                },
                autoAnchors: state.autoAnchors
            });

            // If we are in middle of history stack, remove future states
            if (state.historyIndex < state.history.length - 1) {
                state.history = state.history.slice(0, state.historyIndex + 1);
            }

            state.history.push(snapshot);
            state.historyIndex++;

            // Limit history
            if (state.history.length > 20) {
                state.history.shift();
                state.historyIndex--;
            }
        }

        function handleUndo() {
            if (state.historyIndex > 0) {
                state.historyIndex--;
                const prevSnapshot = JSON.parse(state.history[state.historyIndex]);
                restoreSnapshot(prevSnapshot);
                showToast("Desfeito", "info");
            }
        }

        // Listen for Ctrl+Z
        window.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                handleUndo();
            }
        });

        function restoreSnapshot(data) {
            if (typeof data.autoAnchors !== 'undefined') {
                state.autoAnchors = data.autoAnchors;
                document.getElementById('cb-auto-anchor').checked = state.autoAnchors;
            }

            // Restore visual properties (x, y, scale, anchors)
            if (data.parts.front) Object.assign(state.model.parts.front, data.parts.front);
            if (data.parts.left) Object.assign(state.model.parts.left, data.parts.left);
            if (data.parts.right) Object.assign(state.model.parts.right, data.parts.right);

            // Note: We don't restore images here because undo usually just moves things.
            // If image URL changed, that's more complex, but for "adjustments" this is enough.

            // Update UI sliders if needed
            if (state.editingPart) {
                const p = state.model.parts[state.editingPart];
                document.getElementById('inp-scale').value = p.scale;
                document.getElementById('val-scale').innerText = p.scale;
            }

            saveConfig(); // Persist
        }


        function switchMode(mode) {
            state.mode = mode;
            const btnEditor = document.getElementById('btn-editor'); const btnPreview = document.getElementById('btn-preview'); const btnConfig = document.getElementById('btn-config');
            const editorView = document.getElementById('admin-editor-view'); const listView = document.getElementById('admin-list-view'); const configView = document.getElementById('admin-config-view'); const uiEditor = document.getElementById('editor-ui');

            // Oculta tudo primeiro
            editorView.classList.add('hidden'); listView.classList.add('hidden'); configView.classList.add('hidden'); uiEditor.classList.add('hidden');

            // Reseta botões
            const inactiveClass = "flex items-center gap-2 px-5 py-2 text-sm font-semibold rounded-lg text-slate-500 hover:text-slate-700 transition-all border border-transparent";
            btnEditor.className = inactiveClass; btnPreview.className = inactiveClass; btnConfig.className = inactiveClass;
            btnEditor.classList.remove('hidden'); btnPreview.classList.remove('hidden'); btnConfig.classList.remove('hidden');

            if (mode === 'editor') {
                btnEditor.classList.add('hidden'); // Esconde botão da aba atual
                editorView.classList.remove('hidden'); uiEditor.classList.remove('hidden');

                if (!state.videoStarted) { init(); loadConfig(); }
                document.getElementById('smart-controls').classList.add('hidden');
                if (!state.editingPart) selectPart('front');
                loadWhatsAppConfig();

            } else if (mode === 'list') {
                btnPreview.classList.add('hidden'); // Esconde botão da aba atual
                listView.classList.remove('hidden');
                renderAdminProductList(); deselectAll();

            } else if (mode === 'config') {
                btnConfig.classList.add('hidden'); // Esconde botão da aba atual
                configView.classList.remove('hidden');
                deselectAll();
            }
        }

        // --- NOVO: Configuração Visual da Loja (Config View) ---
        let tempConfig = { banner: null, logo: null, color: '#2563eb' };

        // Helper para redimensionar imagem (LOGO)
        function resizeImage(file, maxHeight) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const aspect = img.width / img.height;
                    const height = maxHeight;
                    const width = height * aspect;

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob((blob) => {
                        resolve(new File([blob], file.name, { type: 'image/png' }));
                    }, 'image/png');
                };
                img.src = URL.createObjectURL(file);
            });
        }

        function handleConfigUpload(input, type) {
            const file = input.files[0];
            if (!file) return;

            const processUpload = async (fileToUpload) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Atualiza Preview
                    if (type === 'banner') document.getElementById('config-banner-preview').src = e.target.result;
                    if (type === 'logo') {
                        const el = document.getElementById('config-logo-preview');
                        el.src = e.target.result; el.classList.remove('hidden');
                        document.getElementById('config-logo-placeholder').classList.add('hidden');
                    }
                    // Upload para ImgBB
                    uploadToImgBB(fileToUpload).then(url => {
                        if (url) tempConfig[type] = url;
                    });
                };
                reader.readAsDataURL(fileToUpload);
            };

            if (type === 'logo') {
                // Resize logo to ~60px height before uploading
                resizeImage(file, 60).then(resizedFile => processUpload(resizedFile));
            } else {
                processUpload(file);
            }
        }

        function updateConfigPreviewColor(val) {
            tempConfig.color = val;
            document.getElementById('btn-color-preview').style.backgroundColor = val;
        }

        function openSuccessModal() {
            document.getElementById('success-modal').classList.remove('hidden');
            lucide.createIcons(); // Ensure icon renders if not already
        }

        function closeSuccessModalAndGoToVitrine() {
            document.getElementById('success-modal').classList.add('hidden');
            goToVitrine();
        }

        async function saveStoreConfig() {
            if (!CURRENT_STORE_ID) { showToast("Erro: Nenhuma loja selecionada", "error"); return; }

            showToast("Salvando configurações...", "info");

            // Prepara objeto de atualização
            const settings = {
                color: tempConfig.color
            };
            if (tempConfig.banner) settings.banner = tempConfig.banner;
            if (tempConfig.logo) settings.logo = tempConfig.logo;

            // Mesclar com settings existentes se houver (para não perder o que não foi alterado agora)
            if (currentStoreData && currentStoreData.settings) {
                if (!settings.banner && currentStoreData.settings.banner) settings.banner = currentStoreData.settings.banner;
                if (!settings.logo && currentStoreData.settings.logo) settings.logo = currentStoreData.settings.logo;
            }

            try {
                await db.collection('stores').doc(CURRENT_STORE_ID).update({ settings: settings });
                // showToast("Configurações salvas!", "success"); // Removed toast

                // Atualiza localmente e aplica
                currentStoreData.settings = settings;
                applyStoreSettings(settings);

                // Show Success Modal
                openSuccessModal();

            } catch (e) {
                console.error(e);
                showToast("Erro ao salvar", "error");
            }
        }

        // --- GESTÃO DE LISTA DE ÓCULOS (ADMIN) ---
        function renderAdminProductList() {
            const container = document.getElementById('admin-products-list');
            const filterEl = document.getElementById('admin-category-filter');
            const searchInput = document.getElementById('admin-search-input');
            const selectedCategory = filterEl ? filterEl.value : 'all';
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

            container.innerHTML = '<div class="col-span-full py-12 flex justify-center"><div class="loader"></div></div>';
            if (filterEl && filterEl.options.length <= 1) { categories.forEach(cat => { const opt = document.createElement('option'); opt.value = cat; opt.innerText = cat; filterEl.appendChild(opt); }); }

            let myProducts = cachedProducts.filter(p => p.isCustom);

            if (selectedCategory !== 'all') { myProducts = myProducts.filter(p => p.category === selectedCategory); }
            if (searchTerm) { myProducts = myProducts.filter(p => p.name.toLowerCase().includes(searchTerm)); }

            if (myProducts.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center text-slate-400 py-12 flex flex-col items-center"><div class="bg-slate-100 p-4 rounded-full mb-4"><i data-lucide="glasses" class="w-8 h-8 text-slate-300"></i></div><p class="text-lg font-medium">Nenhum óculos encontrado.</p>${selectedCategory === 'all' && !searchTerm ? '<p class="text-sm">Clique em "Novo Óculos" para começar.</p>' : ''}</div>`;
                lucide.createIcons(); return;
            }
            container.innerHTML = '';
            myProducts.forEach(prod => {
                const isActive = prod.active !== false;
                const statusTextClass = isActive ? 'text-emerald-600' : 'text-slate-400';
                const statusLabel = isActive ? 'Ativo' : 'Desativado';
                const highlightClass = prod._firestoreId === lastEditedProductId ? 'border-green-500 ring-1 ring-green-500' : 'border-slate-200';

                const card = document.createElement('div');
                card.className = `bg-white rounded-xl ${highlightClass} shadow-sm overflow-hidden flex flex-col hover:shadow-md transition-shadow`;
                // UPDATE: aspect-square no container da imagem
                card.innerHTML = `
                    <div class="aspect-square w-full bg-slate-50 p-4 relative flex items-center justify-center border-b border-slate-100"><img src="${prod.image}" class="max-h-full max-w-full object-contain mix-blend-multiply"></div>
                    <div class="p-4 flex-1 flex flex-col">
                        <h3 class="font-bold text-slate-800 text-base mb-1 truncate" title="${prod.name}">${prod.name}</h3>
                        <p class="text-xs text-slate-500 mb-4 font-medium">${prod.category || 'Geral'} • R$ ${prod.price || '0,00'}</p>
                        <div class="mt-auto flex items-center justify-between pt-2 border-t border-slate-100">
                            <div class="flex items-center gap-2">
                                <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" value="" class="sr-only peer" onchange="toggleProductStatus('${prod._firestoreId}', ${isActive})" ${isActive ? 'checked' : ''}><div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-500"></div></label>
                                <span class="text-xs font-bold ${statusTextClass}">${statusLabel}</span>
                            </div>
                            <div class="flex gap-2"><button onclick="editProductForAdmin('${prod.id}')" class="p-2 rounded-lg text-blue-600 hover:bg-blue-50 transition"><i data-lucide="edit-2" class="w-4 h-4"></i></button><button onclick="deleteProduct('${prod._firestoreId}')" class="p-2 rounded-lg text-red-500 hover:bg-red-50 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
            lucide.createIcons();
        }
        async function toggleProductStatus(firestoreId, currentStatus) {
            try { if (!firestoreId) return; await db.collection('products').doc(firestoreId).update({ active: !currentStatus }); showToast(`Produto ${!currentStatus ? 'ativado' : 'desativado'}!`, "success"); await renderVitrine(); renderAdminProductList(); } catch (e) { showToast("Erro ao atualizar status", "error"); }
        }
        async function deleteProduct(firestoreId) {
            if (!firestoreId) return;
            showConfirm("Tem certeza que deseja excluir este óculos permanentemente?", async () => {
                try { await db.collection('products').doc(firestoreId).delete(); showToast("Óculos excluído.", "success"); await renderVitrine(); renderAdminProductList(); } catch (e) { showToast("Erro ao excluir", "error"); }
            });
        }
        function editProductForAdmin(internalId) {
            const prod = cachedProducts.find(p => p.id == internalId);
            if (!prod) { showToast("Erro: Produto não encontrado", "error"); return; }
            state.editingId = prod._firestoreId;

            // Preenche dados básicos
            document.getElementById('prod-name').value = prod.name;
            document.getElementById('prod-price').value = prod.price;
            document.getElementById('prod-link').value = prod.buyLink || '';
            document.getElementById('prod-category').value = prod.category || 'Unissex';

            // --- Lógica de UI para Imagem de Capa ---
            const radios = document.getElementsByName('cover_source');
            const customContainer = document.getElementById('cover-custom-container');
            const previewContainer = document.getElementById('cover-preview-container');
            const previewImg = document.getElementById('final-cover-preview');
            const uploadText = document.getElementById('cover-upload-text');

            if (prod.imageSource === 'custom') {
                // Se for Custom, ativa a opção e mostra o preview
                radios[1].checked = true; // "Usar outra imagem"
                coverState.mode = 'custom';
                coverState.croppedDataUrl = prod.image; // Usa a URL salva para preview

                customContainer.classList.remove('hidden');
                previewContainer.classList.remove('hidden');
                previewImg.src = prod.image;
                uploadText.innerText = "Trocar imagem";
            } else {
                // Se for Front (ou legado), reseta para o padrão
                radios[0].checked = true; // "Usar frente"
                coverState.mode = 'front';
                customContainer.classList.add('hidden'); // Esconde tudo
                resetCoverImage();
            }

            if (prod.arConfig) applyGlassesConfig(prod.arConfig);

            showToast(`Editando: ${prod.name}`, "info");
            switchMode('editor');

            // Re-aplicar config do WA (para garantir que os valores no input estejam corretos caso seja automático)
            // Mas não forçamos sobrescrita do link se o usuário já editou manualmente antes
            // A lógica de updateWhatsAppLink só roda se o checkbox estiver marcado.
            // Se estiver marcado, ele sobrescreve. É o comportamento desejado para "automático".
            loadWhatsAppConfig();
        }

        function resetEditor() {
            document.getElementById('prod-name').value = ''; document.getElementById('prod-price').value = ''; document.getElementById('prod-link').value = ''; state.editingId = null;
            ['front', 'left', 'right'].forEach(p => {
                state.model.parts[p].img = null; state.model.parts[p].remoteUrl = null;
                document.getElementById(`thumb-${p}`).classList.add('hidden');
                const btn = document.getElementById(`thumb-${p}`).parentElement.nextElementSibling;
                const dot = btn.querySelector('.upload-status-dot'); if (dot) dot.classList.add('hidden');
            });

            // Resetar capa para padrão
            resetCoverImage();
            document.getElementsByName('cover_source')[0].checked = true; // Garante check visual
            document.getElementById('cover-custom-container').classList.add('hidden'); // Garante oculto

            showToast("Editor limpo para novo óculos", "info");
            switchMode('editor');

            // Recarregar configurações do WhatsApp para novo item
            loadWhatsAppConfig();

            // NOVO: Força a geração do link se a opção estiver ativa
            if (document.getElementById('wa-auto-generate').checked) {
                updateWhatsAppLink(true);
            }
        }

        // --- MANIPULAÇÃO DO EDITOR ---
        function togglePart(partName) {
            const cb = document.getElementById(`cb-${partName}`);
            if (cb.checked) {
                ['front', 'left', 'right'].forEach(p => { if (p !== partName) document.getElementById(`cb-${p}`).checked = false; });
                state.editingPart = partName;
            } else { state.editingPart = null; }
            updateUI();
        }
        function selectPart(partName) { if (state.mode !== 'editor') return; const cb = document.getElementById(`cb-${partName}`); if (!cb.checked) { cb.checked = true; togglePart(partName); } }
        function deselectAll() { state.editingPart = null;['front', 'left', 'right'].forEach(p => document.getElementById(`cb-${p}`).checked = false); updateUI(); }
        function toggleAutoAnchor(val) { state.autoAnchors = val; if (val) snapAnchorsToFront(); }
        function snapAnchorsToFront() {
            const front = state.model.parts.front; const left = state.model.parts.left; const right = state.model.parts.right;
            const halfWidth = (front.scale * 0.45); const defaultHingeY = front.y - (front.scale * 0.05);
            left.anchorFrame.x = front.x - halfWidth; left.anchorFrame.y = defaultHingeY; right.anchorFrame.x = front.x + halfWidth; right.anchorFrame.y = defaultHingeY; saveConfig();
        }
        async function uploadToImgBB(file) {
            const formData = new FormData(); formData.append('image', file); formData.append('key', IMGBB_API_KEY);
            try {
                showToast("Enviando...", "info"); const response = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData });
                const data = await response.json(); return data.success ? data.data.url : null;
            } catch (error) { return null; }
        }
        function uploadPart(input, partName) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    state.model.parts[partName].img = img; selectPart(partName);
                    // NOVO: Aplicar template padrão se existir
                    applyDefaultTemplate(partName);

                    const thumb = document.getElementById(`thumb-${partName}`); thumb.src = e.target.result; thumb.classList.remove('hidden');
                    const btn = thumb.parentElement.nextElementSibling; const dot = btn.querySelector('.upload-status-dot'); if (dot) { dot.classList.remove('hidden'); dot.classList.add('bg-yellow-500', 'animate-pulse'); }

                    // === AUTOMATION: LEFT -> RIGHT ===
                    if (partName === 'left') {
                        // Copy image reference to right
                        state.model.parts.right.img = img;
                        // Update Right Thumbnail
                        const thumbRight = document.getElementById('thumb-right');
                        thumbRight.src = e.target.result;
                        thumbRight.classList.remove('hidden');
                        // Show processing dot on right too
                        const btnRight = thumbRight.parentElement.nextElementSibling;
                        const dotRight = btnRight.querySelector('.upload-status-dot');
                        if (dotRight) { dotRight.classList.remove('hidden'); dotRight.classList.add('bg-yellow-500', 'animate-pulse'); }

                        // Mirror geometry if no defaults exist to help user
                        if (!hasDefaultTemplate()) {
                            const left = state.model.parts.left;
                            const right = state.model.parts.right;
                            right.scale = left.scale;
                            // Invert Anchor X for symmetry
                            right.anchorFrame = { x: -left.anchorFrame.x, y: left.anchorFrame.y };
                            right.anchorEar = { x: -left.anchorEar.x, y: left.anchorEar.y };
                            // Copy Y
                            right.y = left.y;
                        }
                    }

                    if (partName === 'front' && !hasDefaultTemplate()) { // Só aplica auto se NÃO houver template
                        state.autoAnchors = true; document.getElementById('cb-auto-anchor').checked = true; snapAnchorsToFront(); showToast("Âncoras automáticas!", "success");
                    }
                    if ((partName === 'left' || partName === 'right') && !hasDefaultTemplate() && partName !== 'left') { // Only copy if NOT left (left handles itself now)
                        const otherName = partName === 'left' ? 'right' : 'left'; const otherPart = state.model.parts[otherName];
                        if (otherPart.img) { const currentPart = state.model.parts[partName]; currentPart.scale = otherPart.scale; currentPart.x = otherPart.x; currentPart.y = otherPart.y; currentPart.anchorFrame = { x: -otherPart.anchorFrame.x, y: otherPart.anchorFrame.y }; currentPart.anchorEar = { x: -otherPart.anchorEar.x, y: otherPart.anchorEar.y }; }
                    }
                    updateUI();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            uploadToImgBB(file).then(url => {
                const setUrl = (p, u) => {
                    state.model.parts[p].remoteUrl = u;
                    const thumb = document.getElementById(`thumb-${p}`);
                    const btn = thumb.parentElement.nextElementSibling;
                    const dot = btn.querySelector('.upload-status-dot');
                    if (u) {
                        if (dot) { dot.className = 'upload-status-dot absolute top-1.5 right-1.5 w-2 h-2 rounded-full bg-green-500 shadow-md'; }
                    } else {
                        if (dot) { dot.className = 'upload-status-dot absolute top-1.5 right-1.5 w-2 h-2 rounded-full bg-red-500 shadow-md'; }
                    }
                };

                setUrl(partName, url);

                // Mirror remote URL to right if left was uploaded
                if (partName === 'left' && url) {
                    setUrl('right', url);
                }

                saveConfig();
            });
        }

        // --- FUNÇÕES DE TEMPLATE PADRÃO ---
        function saveCurrentAsDefault() {
            const defaults = {
                front: { x: state.model.parts.front.x, y: state.model.parts.front.y, scale: state.model.parts.front.scale },
                left: { ...state.model.parts.left, img: undefined, remoteUrl: undefined },
                right: { ...state.model.parts.right, img: undefined, remoteUrl: undefined },
                autoAnchors: state.autoAnchors
            };
            // Remove propriedades de imagem do objeto salvo
            delete defaults.left.img; delete defaults.left.remoteUrl;
            delete defaults.right.img; delete defaults.right.remoteUrl;

            safeStorage.setItem('ar_default_template', JSON.stringify(defaults));
            showToast("Configuração salva como Padrão!", "success");
        }

        function hasDefaultTemplate() {
            return !!safeStorage.getItem('ar_default_template');
        }

        function applyDefaultTemplate(partName) {
            const saved = safeStorage.getItem('ar_default_template');
            if (!saved) return;

            try {
                const def = JSON.parse(saved);
                const part = state.model.parts[partName];

                if (partName === 'front') {
                    part.x = def.front.x;
                    part.y = def.front.y;
                    part.scale = def.front.scale;
                    state.autoAnchors = def.autoAnchors;
                    document.getElementById('cb-auto-anchor').checked = state.autoAnchors;
                } else if (partName === 'left') {
                    // Mantém a imagem, sobrescreve posições e âncoras
                    const img = part.img;
                    const url = part.remoteUrl;
                    Object.assign(part, def.left);
                    part.img = img;
                    part.remoteUrl = url;
                } else if (partName === 'right') {
                    const img = part.img;
                    const url = part.remoteUrl;
                    Object.assign(part, def.right);
                    part.img = img;
                    part.remoteUrl = url;
                }

                showToast("Ajustes padrão aplicados", "info");
            } catch (e) {
                console.error("Erro ao aplicar template", e);
            }
        }

        function saveConfig() {
            const dataToSave = { front: state.model.parts.front.remoteUrl, left: state.model.parts.left.remoteUrl, right: state.model.parts.right.remoteUrl, frontParams: { x: state.model.parts.front.x, y: state.model.parts.front.y, scale: state.model.parts.front.scale }, leftParams: { ...state.model.parts.left }, rightParams: { ...state.model.parts.right }, autoAnchors: state.autoAnchors };
            delete dataToSave.leftParams.img; delete dataToSave.rightParams.img; safeStorage.setItem('ar_glasses_config', JSON.stringify(dataToSave));
        }
        function loadConfig() {
            const saved = safeStorage.getItem('ar_glasses_config');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (typeof data.autoAnchors !== 'undefined') { state.autoAnchors = data.autoAnchors; document.getElementById('cb-auto-anchor').checked = state.autoAnchors; }
                    ['front', 'left', 'right'].forEach(p => {
                        const remoteUrl = (p === 'front') ? data.front : (p === 'left' ? data.left : data.right);
                        if (remoteUrl) { const img = new Image(); img.crossOrigin = "Anonymous"; img.onload = () => { state.model.parts[p].img = img; state.model.parts[p].remoteUrl = remoteUrl; const thumb = document.getElementById(`thumb-${p}`); thumb.src = remoteUrl; thumb.classList.remove('hidden'); }; img.src = remoteUrl; }
                    });
                    if (data.frontParams) Object.assign(state.model.parts.front, data.frontParams);
                    if (data.leftParams) { state.model.parts.left.scale = data.leftParams.scale; state.model.parts.left.x = data.leftParams.x; state.model.parts.left.y = data.leftParams.y; if (data.leftParams.anchorFrame) state.model.parts.left.anchorFrame = data.leftParams.anchorFrame; if (data.leftParams.anchorEar) state.model.parts.left.anchorEar = data.leftParams.anchorEar; }
                    if (data.rightParams) { state.model.parts.right.scale = data.rightParams.scale; state.model.parts.right.x = data.rightParams.x; state.model.parts.right.y = data.rightParams.y; if (data.rightParams.anchorFrame) state.model.parts.right.anchorFrame = data.rightParams.anchorFrame; if (data.rightParams.anchorEar) state.model.parts.right.anchorEar = data.rightParams.anchorEar; }
                } catch (e) { }
            }
        }
        function clearStorage() { safeStorage.removeItem('ar_glasses_config'); showToast("Reiniciando...", "info"); setTimeout(() => location.reload(), 1000); }
        function updateSmartParam(prop, value) {
            if (!state.editingPart) return; const p = state.model.parts[state.editingPart]; p[prop] = parseFloat(value);
            if (prop === 'scale') document.getElementById('val-scale').innerText = value;
            if (state.editingPart === 'front' && state.autoAnchors) { snapAnchorsToFront(); } saveConfig();
            pushHistory(); // Add to history on change
        }

        // --- GESTÃO UI DE AJUSTES FINOS ---
        function updateUI() {
            ['front', 'left', 'right'].forEach(p => {
                const card = document.getElementById(`card-${p}`); const cb = document.getElementById(`cb-${p}`);
                if (state.editingPart === p) { card.classList.add('active'); cb.checked = true; } else { card.classList.remove('active'); cb.checked = false; }
            });
            const label = document.getElementById('editing-label'); const indicator = document.getElementById('edit-indicator');
            const controls = document.getElementById('smart-controls'); // O Container de Ajustes
            const dragHint = document.getElementById('drag-hint'); const hintContent = document.getElementById('hint-content'); const ctrlScale = document.getElementById('ctrl-scale'); const autoAnchorControl = document.getElementById('auto-anchor-control');

            if (state.editingPart) {
                const map = { front: 'Frente', left: 'Haste Esq.', right: 'Haste Dir.' };
                label.innerHTML = `<i data-lucide="edit" class="w-4 h-4"></i> ${map[state.editingPart]}`;
                indicator.classList.remove('opacity-50');

                // NOVO: Reposicionamento Dinâmico dos Controles
                const activeCard = document.getElementById(`card-${state.editingPart}`);
                if (activeCard && controls) {
                    activeCard.insertAdjacentElement('afterend', controls);
                    controls.classList.remove('hidden');
                    // Efeito de fade-in
                    setTimeout(() => { controls.style.opacity = '1'; }, 10);
                }
                controls.style.pointerEvents = 'auto';

                const p = state.model.parts[state.editingPart];
                document.getElementById('inp-scale').value = p.scale; document.getElementById('val-scale').innerText = p.scale;
                if (state.editingPart === 'front') {
                    ctrlScale.classList.remove('disabled-control'); autoAnchorControl.classList.remove('hidden'); dragHint.classList.remove('hidden'); hintContent.innerHTML = `<span class="flex items-center gap-2"><i data-lucide="move" class="w-4 h-4 text-blue-300"></i> Arraste para mover</span>`;
                } else {
                    ctrlScale.classList.remove('disabled-control'); autoAnchorControl.classList.add('hidden'); dragHint.classList.remove('hidden'); hintContent.innerHTML = `<div class="flex flex-col gap-1 items-center text-xs text-blue-50"><span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-blue-400"></div> Ajuste as âncoras</span></div>`;
                }
                lucide.createIcons();
            } else {
                label.innerHTML = "Selecione uma peça"; indicator.classList.add('opacity-50');
                // NOVO: Esconder controles se nada selecionado
                controls.classList.add('hidden');
                controls.style.opacity = '0';
                controls.style.pointerEvents = 'none'; dragHint.classList.add('hidden');
            }
        }

        // --- GESTÃO DE IMAGEM DE CAPA (VITRINE) ---
        let coverState = {
            mode: 'front', // 'front' | 'custom'
            img: null,
            croppedDataUrl: null
        };

        // Estado do Crop Modal
        let cropState = {
            img: null,
            scale: 1,
            x: 0,
            y: 0,
            isDragging: false,
            lastX: 0,
            lastY: 0
        };

        function toggleCoverMode() {
            const radios = document.getElementsByName('cover_source');
            let selected = 'front';
            for (const r of radios) { if (r.checked) selected = r.value; }
            coverState.mode = selected;

            const container = document.getElementById('cover-custom-container');
            if (selected === 'custom') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        // MODAL DE CROP: Abertura e Carregamento
        function handleCoverUpload(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    openCropModal(img);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            input.value = ''; // Reset para permitir re-upload
        }

        function openCropModal(img) {
            const modal = document.getElementById('crop-modal');
            modal.classList.remove('hidden');
            cropState.img = img;
            cropState.scale = 1;
            cropState.x = 0;
            cropState.y = 0;
            document.getElementById('crop-zoom').value = 1;

            drawCropCanvas();
        }

        function closeCropModal() {
            document.getElementById('crop-modal').classList.add('hidden');
        }

        // CROP CANVAS LOGIC
        const cropCanvas = document.getElementById('crop-canvas');
        const cropCtx = cropCanvas.getContext('2d');
        const cropArea = document.getElementById('crop-area');

        // Renderiza o canvas de recorte
        function drawCropCanvas() {
            if (!cropState.img) return;
            // Define o tamanho do canvas com base no container (quadrado)
            const size = cropArea.clientWidth;
            cropCanvas.width = size;
            cropCanvas.height = size;

            // Fundo Branco
            cropCtx.fillStyle = '#ffffff';
            cropCtx.fillRect(0, 0, size, size);

            // Calcula dimensões para "cover" inicial ou ajuste
            const imgAspect = cropState.img.width / cropState.img.height;
            let drawW, drawH;

            // Ajuste inicial para preencher o quadrado (comportamento "cover" base)
            if (imgAspect > 1) {
                drawH = size;
                drawW = size * imgAspect;
            } else {
                drawW = size;
                drawH = size / imgAspect;
            }

            // Aplica Zoom e Pan
            const w = drawW * cropState.scale;
            const h = drawH * cropState.scale;
            const cx = size / 2;
            const cy = size / 2;

            // Centraliza e aplica offset
            const x = cx - (w / 2) + cropState.x;
            const y = cy - (h / 2) + cropState.y;

            cropCtx.drawImage(cropState.img, x, y, w, h);
        }

        // Eventos de Drag & Zoom no Crop
        document.getElementById('crop-zoom').addEventListener('input', (e) => {
            cropState.scale = parseFloat(e.target.value);
            drawCropCanvas();
        });

        function getClientPos(e) {
            return {
                x: e.touches ? e.touches[0].clientX : e.clientX,
                y: e.touches ? e.touches[0].clientY : e.clientY
            };
        }

        const cropAreaEl = document.getElementById('crop-area');
        if (cropAreaEl) {
            cropAreaEl.addEventListener('mousedown', startCropDrag);
            cropAreaEl.addEventListener('touchstart', startCropDrag, { passive: false });
            window.addEventListener('mousemove', moveCropDrag);
            window.addEventListener('touchmove', moveCropDrag, { passive: false });
            window.addEventListener('mouseup', endCropDrag);
            window.addEventListener('touchend', endCropDrag);
        }

        function startCropDrag(e) {
            cropState.isDragging = true;
            const pos = getClientPos(e);
            cropState.lastX = pos.x;
            cropState.lastY = pos.y;
            if (e.cancelable) e.preventDefault();
        }

        function moveCropDrag(e) {
            if (!cropState.isDragging) return;
            const pos = getClientPos(e);
            const dx = pos.x - cropState.lastX;
            const dy = pos.y - cropState.lastY;
            cropState.lastX = pos.x;
            cropState.lastY = pos.y;

            cropState.x += dx;
            cropState.y += dy;
            drawCropCanvas();
            if (e.cancelable) e.preventDefault();
        }

        function endCropDrag() {
            cropState.isDragging = false;
        }

        // Confirmação do Recorte
        function confirmCrop() {
            if (!cropState.img) return;

            // Gera DataURL do canvas atual
            const dataUrl = cropCanvas.toDataURL('image/jpeg', 0.9);
            coverState.croppedDataUrl = dataUrl;

            // Atualiza UI do editor para mostrar preview
            const previewContainer = document.getElementById('cover-preview-container');
            const previewImg = document.getElementById('final-cover-preview');
            const uploadText = document.getElementById('cover-upload-text');

            previewImg.src = dataUrl;
            previewContainer.classList.remove('hidden');
            // Oculta o input original visualmente ou muda texto
            uploadText.innerText = "Imagem Definida";

            closeCropModal();
        }

        function resetCoverImage() {
            coverState = { mode: 'front', img: null, croppedDataUrl: null };
            // Não alteramos checkbox aqui, apenas estado interno e UI interna
            document.getElementById('cover-preview-container').classList.add('hidden');
            document.getElementById('cover-upload-text').innerText = "Clique para enviar imagem";
        }

        async function generateFinalCoverImage() {
            if (coverState.mode === 'front') {
                return state.model.parts.front.remoteUrl || state.model.parts.front.img?.src;
            }
            if (coverState.mode === 'custom' && coverState.croppedDataUrl) {
                // Se a URL já for remota (edição sem troca), retorna ela
                if (coverState.croppedDataUrl.startsWith('http')) return coverState.croppedDataUrl;

                // Upload para ImgBB da imagem já recortada (DataURL)
                const res = await fetch(coverState.croppedDataUrl);
                const blob = await res.blob();
                const file = new File([blob], "cover_cropped.jpg", { type: "image/jpeg" });

                const uploadedUrl = await uploadToImgBB(file);
                return uploadedUrl || coverState.croppedDataUrl; // Fallback
            }
            return null;
        }

        // --- AR HELPER & EVENTS ---
        let isDragging = false; let isRightDragging = false; let lastX = 0, lastY = 0;
        canvasWrapper.addEventListener('contextmenu', e => e.preventDefault());
        function getMousePos(e) { const rect = canvas.getBoundingClientRect(); const scaleX = canvas.width / rect.width; const scaleY = canvas.height / rect.height; return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY }; }
        function checkHit(x, y) {
            if (!state.editingPart || !state.smoothed.x) return null;
            if (state.editingPart === 'front') return 'part';
            if (state.editingPart === 'left' || state.editingPart === 'right') {
                if (state.lastAnchors) {
                    const anchors = state.lastAnchors; const hitRadius = 8; const touchMargin = 2; const totalHit = hitRadius + touchMargin;
                    const dx1 = x - anchors.frame.x; const dy1 = y - anchors.frame.y; if (Math.sqrt(dx1 * dx1 + dy1 * dy1) < totalHit) return 'anchorFrame';
                    const dx2 = x - anchors.ear.x; const dy2 = y - anchors.ear.y; if (Math.sqrt(dx2 * dx2 + dy2 * dy2) < totalHit) return 'anchorEar';
                } return null;
            } return null;
        }
        function handlePointerDown(e) {
            if (!document.getElementById('tryon-overlay').classList.contains('hidden')) return; // BLOCK TRYON DRAG
            if (state.mode !== 'editor' || !state.editingPart) return;
            if (e.button === 2 && (state.editingPart === 'left' || state.editingPart === 'right')) { isRightDragging = true; const pos = getMousePos(e); lastY = pos.y; canvasWrapper.classList.add('grabbing'); canvasWrapper.style.cursor = 'grabbing'; e.preventDefault(); return; }

            // NOVO: Impedir arrastar com botão esquerdo na FRENTE (apenas desktop/mouse)
            // Se for mouse (e.button definido) e não for botão direito (2), ignora para 'front'
            if (state.editingPart === 'front' && typeof e.button === 'number' && e.button !== 2) return;

            const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; const pos = getMousePos({ clientX, clientY }); const target = checkHit(pos.x, pos.y);
            if (target) {
                isDragging = true; state.dragTarget = target; lastX = pos.x; lastY = pos.y; canvasWrapper.classList.add('grabbing');
                if (target === 'anchorFrame') { state.autoAnchors = false; document.getElementById('cb-auto-anchor').checked = false; }
                if (e.cancelable) e.preventDefault();
            }
        }
        function handlePointerMove(e) {
            if (!document.getElementById('tryon-overlay').classList.contains('hidden')) return; // BLOCK TRYON HOVER
            const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; const pos = getMousePos({ clientX, clientY });
            if (isRightDragging) { const dy = pos.y - lastY; lastY = pos.y; const part = state.model.parts[state.editingPart]; const faceWidth = state.smoothed.w || 100; if (state.editingPart === 'right') { part.y += dy / faceWidth; } else { part.y += dy / faceWidth; } canvasWrapper.style.cursor = 'grabbing'; return; }
            if ((!isDragging && !isRightDragging) || !state.editingPart || !state.dragTarget) { const hit = checkHit(pos.x, pos.y); state.hoverTarget = hit; if (hit === 'anchorFrame' || hit === 'anchorEar') { canvasWrapper.style.cursor = 'crosshair'; } else if (hit) { canvasWrapper.style.cursor = 'pointer'; } else { canvasWrapper.style.cursor = 'default'; } return; }
            if (e.cancelable) e.preventDefault(); const dx = pos.x - lastX; const dy = pos.y - lastY; lastX = pos.x; lastY = pos.y; const part = state.model.parts[state.editingPart]; const faceWidth = state.smoothed.w || 100;
            if (state.editingPart === 'front') {
                part.x -= dx / faceWidth; part.y += dy / faceWidth;
                if (state.autoAnchors) snapAnchorsToFront();
            } else {
                if (state.dragTarget === 'part') {
                    if (state.lastAnchors) { const a1 = state.lastAnchors.frame; const a2 = state.lastAnchors.ear; let vx = a2.x - a1.x; let vy = a2.y - a1.y; const len = Math.sqrt(vx * vx + vy * vy); if (len > 0) { vx /= len; vy /= len; const px = -vy; const py = vx; const dPartX = dx * vx + dy * vy; let dPartY = dx * px + dy * py; dPartY = -dPartY; part.x += dPartX / faceWidth; part.y += dPartY / faceWidth; } }
                } else if (state.dragTarget === 'anchorFrame' || state.dragTarget === 'anchorEar') {
                    const ang = -state.smoothed.angle;
                    const cos = Math.cos(ang);
                    const sin = Math.sin(ang);
                    const mdx = -dx;
                    // Transform screen delta to local space
                    const localDx = mdx * cos - dy * sin;
                    const localDy = mdx * sin + dy * cos;
                    const relDx = localDx / faceWidth;
                    const relDy = localDy / faceWidth;

                    if (state.dragTarget === 'anchorFrame') {
                        // Blue Anchor (Frame)
                        part.anchorFrame.x += relDx;
                        part.anchorFrame.y += relDy;
                    } else {
                        // Green Anchor (Ear)
                        // X moves anchor X (Length/Stretch)
                        part.anchorEar.x += relDx;
                        // Y moves ANCHOR EAR Y (Tip Rotation) instead of whole part
                        part.anchorEar.y += relDy;
                    }
                }
            }
        }
        function handleKeyDown(e) {
            if (state.mode !== 'editor') return;
            const part = state.model.parts[state.editingPart];
            if (!part) return;

            const step = 0.005; // Ajuste fino

            // Movement logic for both Front AND Temples
            if (e.key === 'ArrowUp') { part.y -= step; e.preventDefault(); }
            if (e.key === 'ArrowDown') { part.y += step; e.preventDefault(); }
            // For Temples (Left/Right), X logic might need to be relative or flipped? 
            // For simplicity, standard X logic. For front it's += or -= based on direction.
            // Let's standardize: Left/Right arrows move along X axis.
            if (e.key === 'ArrowLeft') {
                if (state.editingPart === 'front') part.x += step; // Front X is inverted in logic elsewhere? (part.x -= dx...)
                else part.x -= step;
                e.preventDefault();
            }
            if (e.key === 'ArrowRight') {
                if (state.editingPart === 'front') part.x -= step;
                else part.x += step;
                e.preventDefault();
            }

            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                if (state.editingPart === 'front' && state.autoAnchors) snapAnchorsToFront();
                saveConfig();
            }
        }
        function handlePointerUp() {
            if (isRightDragging) { isRightDragging = false; canvasWrapper.style.cursor = 'default'; canvasWrapper.classList.remove('grabbing'); saveConfig(); pushHistory(); return; }
            if (isDragging) { isDragging = false; state.dragTarget = null; canvasWrapper.classList.remove('grabbing'); saveConfig(); pushHistory(); }
        }
        function handleZoom(e) { e.preventDefault(); const delta = -Math.sign(e.deltaY) * 0.1; const newZoom = Math.min(Math.max(1, state.zoom + delta), 4); if (newZoom !== state.zoom) { state.zoom = newZoom; const v = document.getElementById('video'); const c = document.getElementById('output-canvas'); v.style.transform = `scaleX(-1) scale(${state.zoom})`; c.style.transform = `scale(${state.zoom})`; } }
        canvasWrapper.addEventListener('wheel', handleZoom, { passive: false }); canvasWrapper.addEventListener('mousedown', handlePointerDown); window.addEventListener('mousemove', handlePointerMove); window.addEventListener('mouseup', handlePointerUp); canvasWrapper.addEventListener('touchstart', handlePointerDown, { passive: false }); window.addEventListener('touchmove', handlePointerMove, { passive: false }); window.addEventListener('touchend', handlePointerUp); window.addEventListener('keydown', handleKeyDown);

        // --- PUBLICAR (Salva Novo Item) ---
        async function publishModel() {
            if (!state.model.parts.front.img) { showToast("Falta imagem da frente!", "error"); return; }
            const nameVal = document.getElementById('prod-name').value; const catVal = document.getElementById('prod-category').value; const priceVal = document.getElementById('prod-price').value; const linkVal = document.getElementById('prod-link').value;
            if (!nameVal) { showToast("Defina um nome para o modelo", "error"); document.getElementById('prod-name').focus(); return; }

            // Lógica de Capa Atualizada
            let imgSrc = null;
            showToast("Processando imagem de capa...", "info");
            try {
                imgSrc = await generateFinalCoverImage();
            } catch (e) {
                console.error("Erro capa:", e);
                showToast("Erro ao processar imagem de capa", "error");
                return;
            }

            if (!imgSrc) {
                showToast("Erro: Imagem de capa inválida", "error");
                return;
            }

            const newId = Date.now();
            const arConfig = {
                front: state.model.parts.front.remoteUrl || state.model.parts.front.img.src,
                left: state.model.parts.left.remoteUrl || (state.model.parts.left.img ? state.model.parts.left.img.src : null),
                right: state.model.parts.right.remoteUrl || (state.model.parts.right.img ? state.model.parts.right.img.src : null),
                frontParams: { x: state.model.parts.front.x, y: state.model.parts.front.y, scale: state.model.parts.front.scale }, leftParams: { ...state.model.parts.left }, rightParams: { ...state.model.parts.right }, autoAnchors: state.autoAnchors
            };
            delete arConfig.leftParams.img; delete arConfig.rightParams.img;

            // Save imageSource (front vs custom)
            const productData = {
                storeId: CURRENT_STORE_ID,
                name: nameVal,
                category: catVal,
                price: priceVal,
                buyLink: linkVal,
                image: imgSrc,
                imageSource: coverState.mode, // SAVE MODE
                isCustom: true,
                arConfig: arConfig,
                active: true
            };

            showToast("Salvando no Firebase...", "info");

            if (state.editingId) {
                db.collection('products').doc(state.editingId).update(productData)
                    .then(() => {
                        showToast("Óculos salvo com sucesso.", "success"); // TOAST ATUALIZADO
                        lastEditedProductId = state.editingId; // ARMAZENA ID EDITADO
                        setTimeout(() => { switchMode('list'); }, 1500); // REDIRECIONA AUTOMATICAMENTE
                        renderVitrine();
                    })
                    .catch(err => { console.error(err); showToast("Erro ao atualizar", "error"); });
            } else {
                productData.id = newId; productData.createdAt = newId;
                db.collection('products').add(productData)
                    .then((docRef) => {
                        showToast("Óculos salvo com sucesso.", "success"); // TOAST ATUALIZADO
                        lastEditedProductId = docRef.id; // ARMAZENA NOVO ID
                        setTimeout(() => { switchMode('list'); }, 1500); // REDIRECIONA AUTOMATICAMENTE
                        renderVitrine();
                    })
                    .catch((error) => { console.error("Erro ao salvar:", error); showToast("Erro ao salvar no banco de dados.", "error"); });
            }
        }

        function lerp(s, e, t) { return s + (e - s) * t; }

        // --- MEDIAPIPE CORE ---
        async function init() {
            // loadConfig() removido daqui para evitar sobrescrita ao abrir provador
            const faceMesh = new FaceMesh({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}` }); faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 }); faceMesh.onResults(onResults); state.faceMesh = faceMesh; startVideo();
        }

        async function startVideo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: 640, height: 480 } });
                video.srcObject = stream;

                // CORREÇÃO: Aguarda o vídeo carregar os dados antes de dar play para evitar tela preta
                await new Promise((resolve) => {
                    if (video.readyState >= 2) { // HAVE_CURRENT_DATA
                        resolve();
                    } else {
                        video.onloadeddata = () => resolve();
                    }
                });

                await video.play();

                state.videoStarted = true;
                document.getElementById('loading-overlay').classList.add('hidden');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                loop();
                selectPart('front');
            } catch (e) {
                console.error(e);
                showToast("Erro: Câmera inacessível", "error");
            }
        }

        async function loop() { if (!state.videoStarted || !state.faceMesh) return; await state.faceMesh.send({ image: video }); requestAnimationFrame(loop); }
        function onResults(results) {
            ctx.save(); ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.translate(canvas.width, 0); ctx.scale(-1, 1); ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) { renderGlasses(results.multiFaceLandmarks[0]); } ctx.restore();
        }
        function renderGlasses(landmarks) {
            const w = canvas.width; const h = canvas.height; const getPoint = (idx) => ({ x: landmarks[idx].x * w, y: landmarks[idx].y * h });
            const noseTip = getPoint(1); const noseTop = getPoint(168); const lEyeOut = getPoint(33); const rEyeOut = getPoint(263); const jawLeft = getPoint(234); const jawRight = getPoint(454);
            const dx = rEyeOut.x - lEyeOut.x; const dy = rEyeOut.y - lEyeOut.y; const dist = Math.sqrt(dx * dx + dy * dy); const angle = Math.atan2(dy, dx);
            const midX = (lEyeOut.x + rEyeOut.x) / 2; const yaw = (noseTip.x - midX) / dist;
            const target = { x: noseTop.x, y: noseTop.y + (dist * 0.1), w: dist * 2.3, angle: angle, yaw: yaw, jawLeft: jawLeft, jawRight: jawRight };
            const s = state.smoothed; const f = 0.2;
            if (s.x === null) Object.assign(s, target); else { s.x = lerp(s.x, target.x, f); s.y = lerp(s.y, target.y, f); s.w = lerp(s.w, target.w, f); s.angle = lerp(s.angle, target.angle, f); s.yaw = lerp(s.yaw, target.yaw, 0.1); s.jawLeft = { x: lerp(s.jawLeft.x, target.jawLeft.x, f), y: lerp(s.jawLeft.y, target.jawLeft.y, f) }; s.jawRight = { x: lerp(s.jawRight.x, target.jawRight.x, f), y: lerp(s.jawRight.y, target.jawRight.y, f) }; }
            const toPx = (relVal) => relVal * s.w; const transformPoint = (baseX, baseY, relOffsetX, relOffsetY) => { const offsetX = toPx(relOffsetX); const offsetY = toPx(relOffsetY); const cos = Math.cos(s.angle); const sin = Math.sin(s.angle); const rotX = offsetX * cos - offsetY * sin; const rotY = offsetX * sin + offsetY * cos; return { x: baseX + rotX, y: baseY + rotY }; };

            // --- AJUSTE MANUAL AQUI ---
            // YAW_SENSITIVITY: Quanto menor, mais cedo as hastes aparecem. 
            // Padrão era 0.06. Ajustado para 0.04.
            const YAW_SENSITIVITY = 0.04;

            const isLookingSide = Math.abs(s.yaw) > YAW_SENSITIVITY;
            state.showTemples = isLookingSide;

            const drawTempleSmart = (side) => {
                const p = state.model.parts[side]; if (!p.img) return; const isEditingThis = (state.mode === 'editor' && state.editingPart === side); if (!state.showTemples) return;

                let opacity = 1.0;
                // --- AJUSTE FINO DE LADO ---
                // HIDE_THRESHOLD: Limite para esconder o lado oposto.
                const HIDE_THRESHOLD = 0.03;

                if (side === 'left') {
                    if (s.yaw < -HIDE_THRESHOLD) opacity = 0;
                } else {
                    if (s.yaw > HIDE_THRESHOLD) opacity = 0;
                }
                if (opacity <= 0.01) return;

                const posFrame = transformPoint(s.x, s.y, p.anchorFrame.x, p.anchorFrame.y); const baseJaw = side === 'left' ? s.jawLeft : s.jawRight; const posEar = transformPoint(baseJaw.x, baseJaw.y, p.anchorEar.x, p.anchorEar.y);
                const dX = posEar.x - posFrame.x; const dY = posEar.y - posFrame.y; const len = Math.sqrt(dX * dX + dY * dY);

                // NOVO CÁLCULO DE ÂNGULO DINÂMICO
                // Usa Math.atan2(dY, dX) para permitir que a haste rotacione visualmente
                // quando a âncora verde (Ear) sobe ou desce
                const ang = Math.atan2(dY, dX);

                const thickness = (s.w * 0.1) * p.scale;

                ctx.save();
                ctx.globalAlpha = opacity;
                ctx.shadowColor = "rgba(0,0,0,0.5)";
                ctx.shadowBlur = 10;
                ctx.shadowOffsetY = 5;

                // Desenha a partir da âncora da armação (dobradiça)
                ctx.translate(posFrame.x, posFrame.y);
                ctx.rotate(ang); // Rotação dinâmica

                // Importante: Se a haste esquerda deve ir para a esquerda e direita para direita
                // O atan2 já cuida da direção, mas a imagem pode precisar de flip vertical se estiver de cabeça para baixo
                // Devido à geometria, se dX for negativo, a imagem pode ser desenhada invertida dependendo do quadrante

                // Ajuste de espelhamento baseado no lado e no ângulo para garantir que a imagem não fique de cabeça para baixo
                if (side === 'left') {
                    // Para a haste esquerda, a imagem original aponta para a esquerda? 
                    // Se a imagem original aponta para a direita (padrão), e queremos desenhar para a esquerda:
                    // O angulo calculado apontará para a esquerda.

                    // Se a imagem original das hastes sempre aponta para a direita:
                    // Esquerda precisa de flip Y se o angulo rotacionar "demais"? Não necessariamente com atan2.
                    // Mas precisamos garantir que a textura esteja correta (cima/baixo).

                    // Teste simples: Se a imagem original da haste esquerda aponta para a esquerda, ok.
                    // Se ambas apontam para a direita, a esquerda precisa de scale X -1 ANTES da rotação ou depois?
                    // Normalmente as imagens de haste são separadas. Assumimos que a imagem da esquerda "aponta para a esquerda".

                    // Se a imagem da esquerda JÁ aponta para a esquerda, não precisa de scale X -1.
                    // Mas o cálculo de len assume desenho da esquerda para direita (0 a len).
                    // Se a imagem aponta para a esquerda, desenhar de 0 a len pode inverter.

                    // Vamos assumir comportamento padrão: desenhar do ponto 0,0 para a frente.
                    // Com atan2, a "frente" é a direção do ear.

                    // Se a imagem da haste esquerda for desenhada, ela deve ser renderizada corretamente.
                    // O código anterior usava scale(-1, 1) para a esquerda. Vamos manter se necessário.
                    // Mas com atan2, o vetor dX, dY define a rotação.

                    // Se usarmos scale(-1, 1), invertemos o eixo X.
                    // Se a imagem da esquerda aponta para a esquerda, e rotacionamos para apontar para o ear...

                    // Simplificação: Desenha a imagem sempre como se fosse "reta", a rotação cuida do resto.
                    // Se a imagem da esquerda for "invertida" horizontalmente em relação à direita,
                    // talvez precisemos de um flip Y se ela ficar de cabeça para baixo.

                    // O código anterior tinha: if (side === 'left') ctx.scale(-1, 1);
                    // Vamos manter essa lógica de espelhamento se a imagem original exigir.
                    // Mas se a rotação é calculada, talvez baste um flip Y local se abs(ang) > PI/2?

                    // Vamos testar sem scale extra primeiro, apenas desenhando.
                    // Se a imagem aparecer invertida, ajustamos.

                    // A lógica anterior tinha ctx.scale(-1, 1) para a esquerda.
                    // Vou remover para deixar o atan2 controlar, mas se a imagem original da haste esquerda
                    // for um espelho da direita, ela precisa ser desenhada "para trás".

                    // Para garantir compatibilidade com o upload (que geralmente é a peça recortada visualmente):
                    if (Math.abs(ang) > Math.PI / 2) {
                        ctx.scale(1, -1); // Inverte Y se estiver apontando para a esquerda para manter "topo" em cima
                    }
                }

                // Desenha
                ctx.translate(toPx(p.x), toPx(p.y));

                ctx.drawImage(p.img, 0, -thickness / 2, len, thickness);

                ctx.restore();

                if (state.editingPart === side) { state.lastAnchors = { frame: { x: canvas.width - posFrame.x, y: posFrame.y }, ear: { x: canvas.width - posEar.x, y: posEar.y } }; }
                if (state.mode === 'editor' && state.editingPart === side) {
                    ctx.save(); ctx.setTransform(1, 0, 0, 1, 0, 0); ctx.globalAlpha = 1.0;
                    const isHoveredFrame = state.hoverTarget === 'anchorFrame'; const isHoveredEar = state.hoverTarget === 'anchorEar'; const isDraggingFrame = state.dragTarget === 'anchorFrame'; const isDraggingEar = state.dragTarget === 'anchorEar';

                    // Smart Guides (Crosshairs) when dragging Anchor Frame
                    if (isDraggingFrame) {
                        ctx.beginPath(); ctx.strokeStyle = 'rgba(59, 130, 246, 0.5)'; ctx.lineWidth = 1; ctx.setLineDash([5, 5]);
                        ctx.moveTo(state.lastAnchors.frame.x, 0); ctx.lineTo(state.lastAnchors.frame.x, canvas.height);
                        ctx.moveTo(0, state.lastAnchors.frame.y); ctx.lineTo(canvas.width, state.lastAnchors.frame.y);
                        ctx.stroke();
                    }

                    // Refined Anchor Drawing (Minimalist & Clean)
                    const drawAnchor = (x, y, isHovered, isDragging, color, hasRing) => {
                        // Ring Logic
                        if (hasRing) {
                            ctx.beginPath();
                            const ringSize = isHovered || isDragging ? 10 : 7;
                            ctx.arc(x, y, ringSize, 0, 2 * Math.PI);
                            ctx.fillStyle = isDragging ? color + '33' : 'rgba(255,255,255,0.05)';
                            ctx.fill();

                            ctx.lineWidth = 1.5;
                            ctx.strokeStyle = color;
                            ctx.stroke();
                        }

                        // Inner Dot (Always draw)
                        ctx.beginPath();
                        const dotSize = 3;
                        ctx.arc(x, y, dotSize, 0, 2 * Math.PI);
                        ctx.fillStyle = color;
                        ctx.fill();
                    };

                    // Linha conectora pontilhada
                    ctx.beginPath();
                    ctx.moveTo(state.lastAnchors.frame.x, state.lastAnchors.frame.y);
                    ctx.lineTo(state.lastAnchors.ear.x, state.lastAnchors.ear.y);
                    ctx.strokeStyle = 'rgba(255,255,255,0.4)';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([4, 4]);
                    ctx.stroke();
                    ctx.setLineDash([]); // Reset dash

                    // Renderiza as âncoras com cores específicas
                    // Frame Anchor = Azul (#3b82f6), SEM anel (false)
                    drawAnchor(state.lastAnchors.frame.x, state.lastAnchors.frame.y, isHoveredFrame, isDraggingFrame, '#3b82f6', false);

                    // Ear Anchor = Verde (#22c55e), COM anel (true)
                    drawAnchor(state.lastAnchors.ear.x, state.lastAnchors.ear.y, isHoveredEar, isDraggingEar, '#22c55e', true);
                    ctx.restore();
                }
            };
            drawTempleSmart('right'); drawTempleSmart('left');
            const pFront = state.model.parts.front;
            if (pFront.img) { const ratio = pFront.img.width / pFront.img.height; const baseW = s.w * pFront.scale; const baseH = baseW / ratio; const pos = transformPoint(s.x, s.y, pFront.x, pFront.y); ctx.save(); ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 15; ctx.translate(pos.x, pos.y); ctx.rotate(s.angle); ctx.drawImage(pFront.img, -baseW / 2, -baseH / 2, baseW, baseH); ctx.restore(); }
        }
        // --- CONFIG NAVIGATION ---
        window.showConfigMain = () => {
            document.getElementById('config-main-menu').classList.remove('hidden');
            document.getElementById('config-sub-site').classList.add('hidden');
            document.getElementById('config-sub-whatsapp').classList.add('hidden');
        };
        window.showConfigSite = () => {
            document.getElementById('config-main-menu').classList.add('hidden');
            document.getElementById('config-sub-site').classList.remove('hidden');
        };
        window.showConfigWhatsapp = () => {
            document.getElementById('config-main-menu').classList.add('hidden');
            document.getElementById('config-sub-whatsapp').classList.remove('hidden');
        };

        initStoreContext(); 
    </script>
</body>

</html>